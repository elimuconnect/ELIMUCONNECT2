<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Assessment Evidence</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
    }
    input, button {
      padding: 8px;
      width: 100%;
      margin-top: 8px;
    }
    button {
      cursor: pointer;
    }
    .muted {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

<h2>Upload Assessment Evidence</h2>

<p class="muted">
  Upload learner work (photo, PDF, audio, video) as evidence for this competency.
</p>

<input type="file" id="fileInput" />

<button id="uploadBtn">Upload Evidence</button>

<p id="status"></p>

<hr>

<button onclick="window.location.href='assessment-competencies.html'">
  â¬… Back to Assessment
</button>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  const status = document.getElementById("status");
  const fileInput = document.getElementById("fileInput");

  /* ðŸ” Auth check */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* ðŸ“¦ Context */
  const assessmentId = localStorage.getItem("assessment_id");
  const competencyId = localStorage.getItem("current_competency_id");
  const studentIds = JSON.parse(localStorage.getItem("selected_students") || "[]");

  if (!assessmentId || !competencyId || !studentIds.length) {
    status.innerText = "Missing assessment context.";
    throw new Error("Missing context");
  }

  /* â¬† Upload handler */
  document.getElementById("uploadBtn").onclick = async () => {
    const file = fileInput.files[0];
    if (!file) {
      status.innerText = "Please select a file first.";
      return;
    }

    status.innerText = "Uploading evidence...";

    const fileExt = file.name.split(".").pop();
    const filePath =
      `evidence/${assessmentId}/${competencyId}/${crypto.randomUUID()}.${fileExt}`;

    /* 1ï¸âƒ£ Upload to storage */
    const { error: uploadError } = await supabase.storage
      .from("assessment-evidence")
      .upload(filePath, file, { upsert: false });

    if (uploadError) {
      status.innerText = uploadError.message;
      return;
    }

    /* 2ï¸âƒ£ Get public URL */
    const { data: urlData } = supabase.storage
      .from("assessment-evidence")
      .getPublicUrl(filePath);

    const fileUrl = urlData.publicUrl;

    /* âœ… FIX: normalize file type */
    const file_type = getFileType(file);

    /* 3ï¸âƒ£ Save DB records */
    const rows = studentIds.map(student_id => ({
      assessment_id: assessmentId,
      student_id,
      competency_id: competencyId,
      file_url: fileUrl,
      file_type,          // âœ… NOW MATCHES DB CHECK
      uploaded_by: user.id
    }));

    const { error: dbError } = await supabase
      .from("assessment_evidence")
      .insert(rows);

    if (dbError) {
      status.innerText = dbError.message;
      return;
    }

    status.innerText = "âœ… Evidence uploaded successfully.";
    fileInput.value = "";
  };

  /* ðŸ”§ CBC-safe file type mapping */
  function getFileType(file) {
    if (file.type.startsWith("image/")) return "image";
    if (file.type.startsWith("video/")) return "video";
    if (file.type.startsWith("audio/")) return "audio";
    return "document"; // PDFs, DOCX, PPT, etc
  }
</script>

</body>
</html>
