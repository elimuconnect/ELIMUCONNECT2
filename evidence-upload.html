<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Assessment Evidence</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 40px auto;
    }
    input, button {
      padding: 8px;
      width: 100%;
      margin-top: 8px;
    }
    button {
      cursor: pointer;
    }
    .muted {
      color: #666;
      font-size: 0.9em;
    }
  </style>
</head>
<body>

<h2>Upload Assessment Evidence</h2>

<p class="muted">
  Upload learner work (photo, PDF, audio, video) as evidence for this competency.
</p>

<input type="file" id="fileInput" />

<button id="uploadBtn">Upload Evidence</button>

<p id="status"></p>

<hr>

<button onclick="window.location.href='assessment-competencies.html'">
  ‚¨Ö Back to Assessment
</button>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  const status = document.getElementById("status");
  const fileInput = document.getElementById("fileInput");
  const uploadBtn = document.getElementById("uploadBtn");

  /* üîê Auth check */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* üì¶ REQUIRED CONTEXT */
  const competencyAssessmentId =
    localStorage.getItem("competency_assessment_id");

  if (!competencyAssessmentId) {
    status.innerText =
      "Missing competency assessment context. Save results first.";
    throw new Error("Missing competency_assessment_id");
  }

  /* ‚¨Ü Upload handler */
  uploadBtn.onclick = async () => {
    const file = fileInput.files[0];
    if (!file) {
      status.innerText = "Please select a file first.";
      return;
    }

    status.innerText = "Uploading evidence‚Ä¶";

    const fileExt = file.name.split(".").pop();
    const filePath =
      `evidence/${competencyAssessmentId}/${crypto.randomUUID()}.${fileExt}`;

    /* 1Ô∏è‚É£ Upload to storage */
    const { error: uploadError } = await supabase.storage
      .from("assessment-evidence")
      .upload(filePath, file, { upsert: false });

    if (uploadError) {
      status.innerText = uploadError.message;
      return;
    }

    /* 2Ô∏è‚É£ Get public URL */
    const { data: urlData } = supabase.storage
      .from("assessment-evidence")
      .getPublicUrl(filePath);

    const fileUrl = urlData.publicUrl;

    /* 3Ô∏è‚É£ Insert evidence row (FK-safe ‚úÖ) */
    const { error: dbError } = await supabase
      .from("assessment_evidence")
      .insert({
        competency_assessment_id: competencyAssessmentId, // ‚úÖ CORRECT FK
        file_url: fileUrl,
        file_type: getFileType(file),                     // ‚úÖ CHECK OK
        uploaded_by: user.id
      });

    if (dbError) {
      status.innerText = dbError.message;
      return;
    }

    status.innerText = "‚úÖ Evidence uploaded successfully.";
    fileInput.value = "";
  };

  /* üîß MUST MATCH DB CHECK */
  function getFileType(file) {
    const mime = file.type.toLowerCase();

    if (mime.startsWith("image/")) return "image";
    if (mime.startsWith("video/")) return "video";
    if (mime.startsWith("audio/")) return "audio";
    return "document";
  }
</script>

  
</body>
</html>
