<!DOCTYPE html>
<html>
<head>
  <title>Assess Competency</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Assess Competency</h2>

<label>Competency</label><br>
<select id="competency"></select><br><br>

<label>Achievement Level</label><br>
<select id="achievement"></select><br><br>

<label>Remark (optional)</label><br>
<textarea id="remark" rows="3" cols="40"></textarea><br><br>

<button id="saveResults">Save Results</button>

<p id="status"></p>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  /* 0Ô∏è‚É£ Auth check */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* 1Ô∏è‚É£ Load context */
  const assessmentId = localStorage.getItem("assessment_id");
  const studentIds = JSON.parse(localStorage.getItem("selected_students") || "[]");

  if (!assessmentId || !studentIds.length) {
    window.location.href = "teacher.html";
    throw new Error("Missing context");
  }

  /* 2Ô∏è‚É£ Load assessment */
  const { data: assessment, error: assessError } = await supabase
    .from("assessments")
    .select("term_id, academic_year")
    .eq("id", assessmentId)
    .single();

  if (assessError || !assessment) {
    document.getElementById("status").innerText = "Failed to load assessment";
    throw assessError;
  }

  /* 3Ô∏è‚É£ Load competencies */
  const { data: competencies, error: compError } = await supabase
    .from("competencies")
    .select("id, name")
    .order("name");

  if (compError || !competencies.length) {
    document.getElementById("status").innerText = "No competencies found";
    throw compError;
  }

  const competencySelect = document.getElementById("competency");
  competencySelect.innerHTML =
    `<option value="">Select competency</option>` +
    competencies.map(c =>
      `<option value="${c.id}">${c.name}</option>`
    ).join("");

  /* 4Ô∏è‚É£ Load achievement levels */
  const { data: levels, error: levelError } = await supabase
    .from("achievement_levels")
    .select("id, label")
    .order("order_rank", { ascending: true });

  if (levelError || !levels.length) {
    document.getElementById("status").innerText = "No achievement levels found";
    throw levelError;
  }

  const achievementSelect = document.getElementById("achievement");
  achievementSelect.innerHTML =
    `<option value="">Select achievement</option>` +
    levels.map(l =>
      `<option value="${l.id}">${l.label}</option>`
    ).join("");

  /* 5Ô∏è‚É£ Load existing result when competency changes */
  competencySelect.onchange = async () => {
    const competency_id = competencySelect.value;
    if (!competency_id) return;

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    if (existing) {
      achievementSelect.value = existing.achievement_level_id;
      achievementSelect.disabled = true;
      document.getElementById("remark").value = existing.remarks || "";
      document.getElementById("status").innerText =
        "Existing result found. You may edit remarks only.";
    } else {
      achievementSelect.disabled = false;
      achievementSelect.selectedIndex = 0;
      document.getElementById("remark").value = "";
      document.getElementById("status").innerText = "";
    }
  };

  /* 6Ô∏è‚É£ Save results */
  document.getElementById("saveResults").onclick = async () => {
    const competency_id = competencySelect.value;
    const achievement_level_id = achievementSelect.value;
    const remarks = document.getElementById("remark").value;

    if (!competency_id) {
      document.getElementById("status").innerText =
        "Select a competency first.";
      return;
    }

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    /* CASE 1Ô∏è‚É£ Update remarks only */
    if (existing) {
      const { error } = await supabase
        .from("assessment_results")
        .update({ remarks })
        .eq("id", existing.id);

      if (error) {
        document.getElementById("status").innerText = error.message;
        return;
      }

      document.getElementById("status").innerText =
        "Remarks updated successfully.";
      return;
    }

    /* CASE 2Ô∏è‚É£ New result */
    if (!achievement_level_id) {
      document.getElementById("status").innerText =
        "Select achievement level.";
      return;
    }

    const rows = studentIds.map(student_id => ({
      assessment_id: assessmentId,
      student_id,
      competency_id,
      achievement_level_id,
      remarks,
      term: assessment.term_id,
      academic_year: assessment.academic_year
    }));

    const { error } = await supabase
      .from("assessment_results")
      .insert(rows);

    if (error) {
      document.getElementById("status").innerText = error.message;
      return;
    }

    document.getElementById("status").innerText =
      "Results saved. Select another competency to continue.";

    competencySelect.selectedIndex = 0;
    achievementSelect.selectedIndex = 0;
    achievementSelect.disabled = false;
    document.getElementById("remark").value = "";
    competencySelect.focus();
  };

  /* üîß Helper */
  async function loadExistingRemark(student_id, competency_id) {
    const { data, error } = await supabase
      .from("assessment_results")
      .select("id, remarks, achievement_level_id")
      .eq("assessment_id", assessmentId)
      .eq("student_id", student_id)
      .eq("competency_id", competency_id)
      .single();

    if (error || !data) return null;
    return data;
  }
</script>

</body>
</html>
