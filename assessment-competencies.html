<!DOCTYPE html>
<html>
<head>
  <title>Assess Competency</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Assess Competency</h2>

<label>Competency</label><br>
<select id="competency"></select><br><br>

<label>Achievement Level</label><br>
<select id="achievement"></select><br><br>

<label>Remark (optional)</label><br>
<textarea id="remark" rows="3" cols="40"></textarea><br><br>

<button id="saveResults">Save Results</button>

<button id="uploadEvidence" disabled>
  Proceed to Evidence Upload
</button>

<p id="status"></p>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  /* ===============================
     üîí SYSTEM ACADEMIC YEAR
  =============================== */
  const SYSTEM_YEAR = "2026";

  let selectedSubjectId = null;

  /* ===============================
     0Ô∏è‚É£ AUTH CHECK
  =============================== */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* ===============================
     1Ô∏è‚É£ LOAD CONTEXT
  =============================== */
  const assessmentId = localStorage.getItem("assessment_id");
  const studentIds = JSON.parse(localStorage.getItem("selected_students") || "[]");

  if (!assessmentId || !studentIds.length) {
    window.location.href = "teacher.html";
    throw new Error("Missing context");
  }

  /* ===============================
     ELEMENTS
  =============================== */
  const competencySelect = document.getElementById("competency");
  const achievementSelect = document.getElementById("achievement");
  const remarkInput = document.getElementById("remark");
  const uploadBtn = document.getElementById("uploadEvidence");
  const saveBtn = document.getElementById("saveResults");
  const status = document.getElementById("status");

  uploadBtn.disabled = true;

  /* ===============================
     2Ô∏è‚É£ LOAD ASSESSMENT
  =============================== */
  const { data: assessment, error } = await supabase
    .from("assessments")
    .select("academic_year, term, term_id")
    .eq("id", assessmentId)
    .single();

  if (error || !assessment) {
    status.innerText = "Assessment not found.";
    throw new Error("Invalid assessment");
  }

  const academicYear =
    localStorage.getItem("academic_year") ||
    assessment.academic_year ||
    SYSTEM_YEAR;

  localStorage.setItem("academic_year", academicYear);

  if (academicYear !== SYSTEM_YEAR) {
    status.innerText = "Invalid academic year.";
    throw new Error("Academic year mismatch");
  }

  /* ===============================
     RESOLVE TERM NAME
  =============================== */
  let termName = assessment.term;

  if (!termName && assessment.term_id) {
    const { data: termRow } = await supabase
      .from("terms")
      .select("name")
      .eq("id", assessment.term_id)
      .single();

    termName = termRow?.name || null;
  }

  if (!termName) {
    status.innerText = "Term could not be resolved.";
    throw new Error("Term missing");
  }

  /* ===============================
     3Ô∏è‚É£ LOAD ALL ACTIVE COMPETENCIES
     (CBC core + subject-specific)
  =============================== */
  const { data: competencies, error: compError } = await supabase
  .from("competencies")
  .select("id, name, subject_id")
  .or("is_active.is.null,is_active.eq.true")
  .order("name");


  if (compError || !competencies.length) {
    status.innerText = "No competencies available.";
    throw compError;
  }



// Group competencies by subject_id
const grouped = {};

competencies.forEach(c => {
  const key = c.subject_id || "core";
  if (!grouped[key]) grouped[key] = [];
  grouped[key].push(c);
});

let html = `<option value="">Select competency</option>`;

// Render subject competencies
Object.entries(grouped).forEach(([key, comps]) => {
  const label =
    key === "core"
      ? "CBC Core Competencies"
      : "Subject Competencies";

  html += `<optgroup label="${label}">`;

  comps.forEach(c => {
    html += `<option value="${c.id}">${c.name}</option>`;
  });

  html += `</optgroup>`;
});

competencySelect.innerHTML = html;








  

  /* ===============================
     4Ô∏è‚É£ LOAD ACHIEVEMENT LEVELS
  =============================== */
  const { data: levels } = await supabase
    .from("achievement_levels")
    .select("id, label")
    .order("order_rank");

  achievementSelect.innerHTML =
    `<option value="">Select achievement</option>` +
    levels.map(l => `<option value="${l.id}">${l.label}</option>`).join("");

  /* ===============================
     5Ô∏è‚É£ COMPETENCY CHANGE
  =============================== */
  competencySelect.onchange = async () => {
    const competency_id = competencySelect.value;
    const selected = competencies.find(c => c.id === competency_id);

    // ‚úÖ subject_id MAY be null (core competency)
    selectedSubjectId = selected?.subject_id || null;

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    if (existing) {
      achievementSelect.value = existing.achievement_level_id;
      achievementSelect.disabled = true;
      remarkInput.value = existing.remarks || "";
      status.innerText = "Existing result found. Editing remarks only.";
    } else {
      achievementSelect.disabled = false;
      achievementSelect.selectedIndex = 0;
      remarkInput.value = "";
      status.innerText = "";
    }
  };

  /* ===============================
     6Ô∏è‚É£ SAVE RESULTS
  =============================== */
  saveBtn.onclick = async () => {
    const competency_id = competencySelect.value;
    const achievement_level_id = achievementSelect.value;
    const remarks = remarkInput.value;

    if (!competency_id) {
      status.innerText = "Select a competency.";
      return;
    }

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    if (existing) {
      await supabase
        .from("assessment_results")
        .update({ remarks })
        .eq("id", existing.id);
    } else {
      if (!achievement_level_id) {
        status.innerText = "Select achievement level.";
        return;
      }

      const rows = studentIds.map(student_id => ({
        assessment_id: assessmentId,
        student_id,
        competency_id,
        achievement_level_id,
        remarks,
        term: termName,
        academic_year: academicYear
      }));

      await supabase.from("assessment_results").insert(rows);
    }

    const finalAchievementLevelId =
      achievement_level_id || existing?.achievement_level_id;

    /* ‚úÖ subject_id can be NULL for core competencies */
    const { data: ca, error: caError } = await supabase
  .from("competency_assessments")
  .upsert({
    assessment_id: assessmentId,
    student_id: studentIds[0],
    subject_id: selectedSubjectId, // may be NULL
    competency_id,
    achievement_level_id: finalAchievementLevelId,
    term: termName,
    academic_year: academicYear,
    teacher_id: user.id,
    created_by: user.id
  }, {
    onConflict: "assessment_id,student_id,competency_id"
  })
  .select("id")
  .maybeSingle();

if (caError) {
  status.innerText = caError.message;
  return;
}

if (!ca) {
  status.innerText =
    "Results saved, but competency assessment ID missing.";
  return;
}

localStorage.setItem("competency_assessment_id", ca.id);
uploadBtn.disabled = false;
status.innerText = "Results saved. You may upload evidence.";
  };
  /* ===============================
     7Ô∏è‚É£ EVIDENCE REDIRECT
  =============================== */
  uploadBtn.onclick = () => {
    window.location.href = "evidence-upload.html";
  };
  
  /* ===============================
     HELPER
  =============================== */
  async function loadExistingRemark(student_id, competency_id) {
    const { data } = await supabase
      .from("assessment_results")
      .select("id, remarks, achievement_level_id")
      .eq("assessment_id", assessmentId)
      .eq("student_id", student_id)
      .eq("competency_id", competency_id)
      .maybeSingle();

    return data || null;
  }
</script>

</body>
</html>
