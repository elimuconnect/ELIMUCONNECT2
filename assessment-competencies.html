<!DOCTYPE html>
<html>
<head>
  <title>Assess Competency</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Assess Competency</h2>

<label>Competency</label><br>
<select id="competency"></select><br><br>

<label>Achievement Level</label><br>
<select id="achievement"></select><br><br>

<label>Remark (optional)</label><br>
<textarea id="remark" rows="3" cols="40"></textarea><br><br>

<button id="saveResults">Save Results</button>

  <button id="uploadEvidence" disabled>
  Proceed to Evidence Upload
</button>


<p id="status"></p>
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  /* 0️⃣ Auth check */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* 1️⃣ Load context */
  const assessmentId = localStorage.getItem("assessment_id");
  const studentIds = JSON.parse(localStorage.getItem("selected_students") || "[]");

  if (!assessmentId || !studentIds.length) {
    window.location.href = "teacher.html";
    throw new Error("Missing context");
  }

  /* Elements */
  const competencySelect = document.getElementById("competency");
  const achievementSelect = document.getElementById("achievement");
  const remarkInput = document.getElementById("remark");
  const uploadBtn = document.getElementById("uploadEvidence");
  const status = document.getElementById("status");

  uploadBtn.disabled = true;

  /* 2️⃣ Load assessment */
  const { data: assessment } = await supabase
    .from("assessments")
    .select("term_id, academic_year")
    .eq("id", assessmentId)
    .single();

  /* 3️⃣ Load competencies */
  const { data: competencies } = await supabase
    .from("competencies")
    .select("id, name")
    .order("name");

  competencySelect.innerHTML =
    `<option value="">Select competency</option>` +
    competencies.map(c =>
      `<option value="${c.id}">${c.name}</option>`
    ).join("");

  /* 4️⃣ Load achievement levels */
  const { data: levels } = await supabase
    .from("achievement_levels")
    .select("id, label")
    .order("order_rank");

  achievementSelect.innerHTML =
    `<option value="">Select achievement</option>` +
    levels.map(l =>
      `<option value="${l.id}">${l.label}</option>`
    ).join("");

  /* 5️⃣ Handle competency change (ONE handler) */
  competencySelect.onchange = async () => {
    const competency_id = competencySelect.value;

    uploadBtn.disabled = true;
    status.innerText = "";

    if (!competency_id) {
      achievementSelect.disabled = false;
      achievementSelect.selectedIndex = 0;
      remarkInput.value = "";
      return;
    }

    uploadBtn.disabled = false;

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    if (existing) {
      achievementSelect.value = existing.achievement_level_id;
      achievementSelect.disabled = true;
      remarkInput.value = existing.remarks || "";
      status.innerText = "Existing result found. You may edit remarks only.";
    } else {
      achievementSelect.disabled = false;
      achievementSelect.selectedIndex = 0;
      remarkInput.value = "";
    }
  };

  /* 6️⃣ Save results */
  document.getElementById("saveResults").onclick = async () => {
    const competency_id = competencySelect.value;
    const achievement_level_id = achievementSelect.value;
    const remarks = remarkInput.value;

    if (!competency_id) {
      status.innerText = "Select a competency first.";
      return;
    }

    const existing = await loadExistingRemark(studentIds[0], competency_id);

    /* Update remarks only */
    if (existing) {
      await supabase
        .from("assessment_results")
        .update({ remarks })
        .eq("id", existing.id);

      status.innerText = "Remarks updated successfully.";
      return;
    }

    if (!achievement_level_id) {
      status.innerText = "Select achievement level.";
      return;
    }

    const rows = studentIds.map(student_id => ({
      assessment_id: assessmentId,
      student_id,
      competency_id,
      achievement_level_id,
      remarks,
      term: assessment.term_id,
      academic_year: assessment.academic_year
    }));

    await supabase.from("assessment_results").insert(rows);

    status.innerText = "Results saved. You may upload evidence.";
  };

  /* 7️⃣ Evidence upload redirect */
  uploadBtn.onclick = () => {
    localStorage.setItem("current_competency_id", competencySelect.value);
    window.location.href = "evidence-upload.html";
  };

  /* Helper */
  async function loadExistingRemark(student_id, competency_id) {
    const { data } = await supabase
      .from("assessment_results")
      .select("id, remarks, achievement_level_id")
      .eq("assessment_id", assessmentId)
      .eq("student_id", student_id)
      .eq("competency_id", competency_id)
      .single();

    return data || null;
  }
</script>

</body>
</html>
