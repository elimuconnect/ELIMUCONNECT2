<!DOCTYPE html>
<html>
<head>
  <title>New Assessment</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Create New Assessment</h2>

<label>Learning Area</label><br>
<select id="learningArea"></select><br><br>

<label>Assessment Type</label><br>
<select id="assessmentType"></select><br><br>

<label>Term</label><br>
<select id="term"></select><br><br>

<!-- ðŸ”’ Academic year is LOCKED (display only) -->
<label>Academic Year</label><br>
<input id="academicYear" readonly /><br><br>

<button id="createAssessment">Create Assessment</button>

<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// --------------------
// 0ï¸âƒ£ Supabase Client
// --------------------
const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

// --------------------
// 0ï¸âƒ£ Auth check
// --------------------
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  window.location.href = "index.html";
  throw new Error("Not logged in");
}

// --------------------
// âœ… Status element
// --------------------
const status = document.getElementById("status");

// --------------------
// 1ï¸âƒ£ Load class + academic year
// --------------------
const classId = localStorage.getItem("class_id");
const storedYear = localStorage.getItem("academic_year");
if (!classId) {
  window.location.href = "teacher.html";
  throw new Error("No class selected");
}
const SYSTEM_YEAR = 2026;
const academicYear = storedYear || SYSTEM_YEAR;
document.getElementById("academicYear").value = academicYear;

// --------------------
// 2ï¸âƒ£ Load teacher's assigned subjects for this class
// --------------------
const { data: teacherSubjects, error: tsError } = await supabase
  .from("teacher_subjects")
  .select(`
    subject_id,
    subjects(name)
  `)
  .eq("teacher_id", user.id)
  .eq("class_id", classId);

if (tsError || !teacherSubjects?.length) {
  status.innerText = "No subjects assigned for this class";
  throw tsError;
}

// --------------------
// 3ï¸âƒ£ Load learning areas for this class
// --------------------
const { data: learningAreas, error: laError } = await supabase
  .from("learning_areas")
  .select("id, name")
  .eq("class_id", classId);

if (laError) {
  status.innerText = "Failed to load learning areas";
  throw laError;
}

// --------------------
// 4ï¸âƒ£ Combine subjects with learning areas
// --------------------
const subjectsWithAreas = teacherSubjects.map(ts => ({
  subject_id: ts.subject_id,
  subject_name: ts.subject.name,
  learningAreas: [...learningAreas]  // attach all learning areas for this class
}));

// --------------------
// 5ï¸âƒ£ Populate Subject Dropdown
// --------------------
const subjectSelect = document.getElementById("subject");
subjectSelect.innerHTML = subjectsWithAreas
  .map(s => `<option value="${s.subject_id}">${s.subject_name}</option>`)
  .join("");

// --------------------
// 6ï¸âƒ£ Populate Learning Area Dropdown (initially first subject)
// --------------------
const learningAreaSelect = document.getElementById("learningArea");
const updateLearningAreas = (selectedSubjectId) => {
  const areas = subjectsWithAreas.find(s => s.subject_id === selectedSubjectId)?.learningAreas || [];
  learningAreaSelect.innerHTML = areas
    .map(la => `<option value="${la.id}">${la.name}</option>`)
    .join("");
};
updateLearningAreas(subjectSelect.value);

// Update learning areas when subject changes
subjectSelect.onchange = () => updateLearningAreas(subjectSelect.value);

// --------------------
// 7ï¸âƒ£ Load assessment types
// --------------------
const { data: assessmentTypes, error: atError } = await supabase
  .from("assessment_types")
  .select("id, name");

if (atError || !assessmentTypes?.length) {
  status.innerText = "Failed to load assessment types";
  throw atError;
}

const assessmentTypeSelect = document.getElementById("assessmentType");
assessmentTypeSelect.innerHTML = assessmentTypes
  .map(at => `<option value="${at.id}">${at.name}</option>`)
  .join("");

// --------------------
// 8ï¸âƒ£ Load terms
// --------------------
const { data: terms, error: termError } = await supabase
  .from("terms")
  .select("id, name");

if (termError || !terms?.length) {
  status.innerText = "Failed to load terms";
  throw termError;
}

const termSelect = document.getElementById("term");
termSelect.innerHTML = terms
  .map(t => `<option value="${t.id}">${t.name}</option>`)
  .join("");

// --------------------
// 9ï¸âƒ£ Create assessment
// --------------------
document.getElementById("createAssessment").onclick = async () => {
  status.innerText = "";

  const selectedSubjectId = subjectSelect.value;
  const learning_area_id = learningAreaSelect.value;
  const assessment_type_id = assessmentTypeSelect.value;
  const term_id = termSelect.value;

  // Fetch teacher profile
  const { data: profile, error: profileError } = await supabase
    .from("profiles")
    .select("id, school_id")
    .eq("auth_id", user.id)
    .single();

  if (profileError || !profile) {
    status.innerText = "Teacher profile not found";
    return;
  }

  const learningAreaName = learningAreas.find(l => l.id === learning_area_id)?.name || "Assessment";
  const termName = terms.find(t => t.id === term_id)?.name;

  if (!termName) {
    status.innerText = "Invalid term selected";
    return;
  }

  const title = `${learningAreaName} â€“ ${termName} ${academicYear}`;
  const assessment_date = new Date().toISOString().split("T")[0];

  const { data, error } = await supabase
    .from("assessments")
    .insert({
      title,
      assessment_date,
      created_by: user.id,
      teacher_id: profile.id,
      class_id: classId,
      school_id: profile.school_id,
      learning_area_id,
      subject: selectedSubjectId,         // âœ… Include subject for RLS
      assessment_type_id,
      term_id,
      term: termName,
      academic_year: academicYear
    })
    .select()
    .single();

  if (error) {
    status.innerText = error.message;
    return;
  }

  localStorage.setItem("assessment_id", data.id);
  window.location.href = "assessment-competencies.html";
};
</script>

</body>
</html>
