<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Term Report Preview</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #f5f5f5;
    }
  </style>
</head>
<body>

<h2>Teacher Term Report Preview</h2>

<label>Term</label><br />
<select id="termSelect"></select><br /><br />


<button id="loadReport">Load Report</button>

<p id="status"></p>
<hr />

<div id="report"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

/* üîê Auth check */
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  window.location.href = "index.html";
  throw new Error("Not logged in");
}

const termSelect = document.getElementById("termSelect");
const reportDiv = document.getElementById("report");
const status = document.getElementById("status");

/* ===============================
   1Ô∏è‚É£ LOAD TERMS (ID + NAME)
================================ */
const { data: terms, error: termError } = await supabase
  .from("terms")
  .select("id, name")
  .order("name");

if (termError || !terms.length) {
  status.innerText = "Failed to load terms.";
  throw termError;
}

termSelect.innerHTML =
  `<option value="">Select term</option>` +
  terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("");

/* ===============================
   2Ô∏è‚É£ LOAD REPORT
================================ */
document.getElementById("loadReport").onclick = async () => {
  reportDiv.innerHTML = "";
  status.innerText = "";

  const term_id = termSelect.value;
  if (!term_id) {
    status.innerText = "Select a term.";
    return;
  }

  const termName =
    terms.find(t => t.id === term_id)?.name || "";


const { data, error } = await supabase
  .from("assessment_results")
  .select(`
    term,
    academic_year,
    remarks,
    students(first_name, last_name),
    competencies(
      name,
      subjects(name)
    ),
    achievement_levels(label),
    assessments!inner(teacher_id)
  `)
  .eq("assessments.teacher_id", user.id)
  .eq("term", term)
  .order("last_name", { foreignTable: "students" })
  .order("name", { foreignTable: "competencies" });

  
  if (error || !data.length) {
    status.innerText = "No results found for this term.";
    return;
  }

  /* ===============================
     RENDER REPORT
  ============================== */
  reportDiv.innerHTML = `
    <h3>${termName} ‚Äì ${data[0].academic_year}</h3>
    <table>
      <tr>
        <th>Student</th>
        <th>Subject</th>
        <th>Competency</th>
        <th>Achievement</th>
        <th>Remarks</th>
      </tr>
      ${data.map(r => `
        <tr>
          <td>${r.students.first_name} ${r.students.last_name}</td>
          <td>${r.competencies.subjects.name}</td>
          <td>${r.competencies.name}</td>
          <td>${r.achievement_levels.label}</td>
          <td>${r.remarks || ""}</td>
        </tr>
      `).join("")}
    </table>
  `;
};
</script>

</body>
</html>
