<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Term Report Preview</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #f5f5f5;
    }
  </style>
</head>
<body>

<h2>Teacher Term Report Preview</h2>

<label>Term</label><br />
<select id="termSelect"></select><br /><br />


<button id="loadReport">Load Report</button>

<p id="status"></p>
<hr />

<div id="report"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);



const levelColor = {
  "Emerging": "#f8d7da",
  "Approaching": "#fff3cd",
  "Achieved": "#d4edda"
};


  
/* üîê Auth check */
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  window.location.href = "index.html";
  throw new Error("Not logged in");
}

const termSelect = document.getElementById("termSelect");
const reportDiv = document.getElementById("report");
const status = document.getElementById("status");

/* ===============================
   1Ô∏è‚É£ LOAD TERMS (ID + NAME)
================================ */
const { data: terms, error: termError } = await supabase
  .from("terms")
  .select("id, name")
  .order("name");

if (termError || !terms.length) {
  status.innerText = "Failed to load terms.";
  throw termError;
}

termSelect.innerHTML =
  `<option value="">Select term</option>` +
  terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("");

/* ===============================
   2Ô∏è‚É£ LOAD REPORT
================================ */
document.getElementById("loadReport").onclick = async () => {
  reportDiv.innerHTML = "";
  status.innerText = "";

  const term_id = termSelect.value;
  if (!term_id) {
    status.innerText = "Select a term.";
    return;
  }

  const termName =
    terms.find(t => t.id === term_id)?.name || "";
const { data, error } = await supabase
  .from("assessment_results")
  .select(`
    term,
    academic_year,
    remarks,
    students(first_name, last_name),
    competencies(
      name,
      subjects(name)
    ),
    achievement_levels(label)
  `)
  .eq("term", termName)
  .order("last_name", { foreignTable: "students" })
  .order("name", { foreignTable: "competencies" });

  
  if (error || !data.length) {
    status.innerText = "No results found for this term.";
    return;
  }




const grouped = {};

data.forEach(r => {
  const student = `${r.students.first_name} ${r.students.last_name}`;
  const subject = r.competencies.subjects.name;
  const competency = r.competencies.name;

  if (!grouped[student]) grouped[student] = {};
  if (!grouped[student][subject]) grouped[student][subject] = [];

  grouped[student][subject].push({
    competency,
    level: r.achievement_levels.label,
    remarks: r.remarks
  });
});






  
  /* ===============================
     RENDER REPORT
  ============================== */
 reportDiv.innerHTML = `
  <h3>${termName} ‚Äì ${data[0].academic_year}</h3>
  ${Object.entries(grouped).map(([student, subjects]) => `
    <div style="margin-bottom:30px;">
      <h4>üë§ ${student}</h4>

      ${Object.entries(subjects).map(([subject, competencies]) => `
        <div style="margin-left:20px;">
          <h5>üìò ${subject}</h5>

          <table border="1" cellpadding="6" cellspacing="0" width="100%">
            <tr>
              <th>Competency</th>
              <th>Achievement Level</th>
              <th>Teacher Remarks</th>
            </tr>

            ${competencies.map(c => `
  <tr style="background-color:${levelColor[c.level] || '#ffffff'}">
    <td>${c.competency}</td>
    <td><strong>${c.level}</strong></td>
    <td>${c.remarks || "‚Äî"}</td>
  </tr>
`).join("")}

          </table>
        </div>
      `).join("")}
    </div>
  `).join("")}
`;

};
</script>

</body>
</html>
