<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Term Report Preview</title>

  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
    }
    th {
      background: #f5f5f5;
    }
  </style>
</head>
<body>

<h2>Teacher Term Report Preview</h2>

<!-- üîí Academic year is SYSTEM CONTROLLED -->
<label>Academic Year</label><br />
<input id="yearSelect" value="2026" disabled /><br /><br />

<label>Term</label><br />
<select id="termSelect"></select><br /><br />

<p id="status"></p>
<hr />

<div id="report"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

/* ===============================
   üîí SYSTEM ACADEMIC YEAR
================================ */
const SYSTEM_YEAR = "2026";

/* ===============================
   LEVEL COLORS (CBC STYLE)
================================ */
const levelColor = {
  "Below Expectations": "#f8d7da",
  "Approaching Expectations": "#fff3cd",
  "Meeting Expectations": "#d4edda",
  "Exceeding Expectations": "#cce5ff"
};

/* ===============================
   ELEMENTS
================================ */
const yearInput = document.getElementById("yearSelect");
const termSelect = document.getElementById("termSelect");
const reportDiv = document.getElementById("report");
const status = document.getElementById("status");

/* ===============================
   üîê AUTH CHECK
================================ */
const { data: { user } } = await supabase.auth.getUser();
if (!user) {
  window.location.href = "index.html";
  throw new Error("Not logged in");
}

/* ===============================
   1Ô∏è‚É£ LOAD TERMS
================================ */
const { data: terms, error: termError } = await supabase
  .from("terms")
  .select("id, name")
  .order("name");

if (termError || !terms.length) {
  status.innerText = "Failed to load terms.";
  throw termError;
}

termSelect.innerHTML =
  `<option value="">Select term</option>` +
  terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("");

/* ===============================
   2Ô∏è‚É£ LOAD REPORT
================================ */
async function loadReport() {
  reportDiv.innerHTML = "";
  status.innerText = "";

  const academicYear = SYSTEM_YEAR;
  const term_id = termSelect.value;

  if (!term_id) return;

  const termName =
    terms.find(t => t.id === term_id)?.name || "";

  if (!termName) {
    status.innerText = "Invalid term selected.";
    return;
  }

  const { data, error } = await supabase
    .from("assessment_results")
    .select(`
      term,
      academic_year,
      remarks,
      students(first_name, last_name),
      competencies(
        name,
        subjects(name)
      ),
      achievement_levels(label)
    `)
    .eq("term", termName)
    .eq("academic_year", academicYear)
    .order("last_name", { foreignTable: "students" })
    .order("name", { foreignTable: "competencies" });

  if (error || !data.length) {
    status.innerText = "No results found for this term.";
    return;
  }

  /* ===============================
     GROUP RESULTS
  =============================== */
  const grouped = {};

  data.forEach(r => {
    const student = `${r.students.first_name} ${r.students.last_name}`;
    const subject = r.competencies.subjects.name;

    if (!grouped[student]) grouped[student] = {};
    if (!grouped[student][subject]) grouped[student][subject] = [];

    grouped[student][subject].push({
      competency: r.competencies.name,
      level: r.achievement_levels.label,
      remarks: r.remarks
    });
  });

  /* ===============================
     RENDER REPORT
  =============================== */
  reportDiv.innerHTML = `
    <h3>${termName} ‚Äì ${academicYear}</h3>

    ${Object.entries(grouped).map(([student, subjects]) => `
      <div style="margin-bottom:30px;">
        <h4>üë§ ${student}</h4>

        ${Object.entries(subjects).map(([subject, competencies]) => `
          <div style="margin-left:20px;">
            <h5>üìò ${subject}</h5>

            <table>
              <tr>
                <th>Competency</th>
                <th>Achievement Level</th>
                <th>Teacher Remarks</th>
              </tr>

              ${competencies.map(c => `
                <tr style="background-color:${levelColor[c.level] || '#fff'}">
                  <td>${c.competency}</td>
                  <td><strong>${c.level}</strong></td>
                  <td>${c.remarks || "‚Äî"}</td>
                </tr>
              `).join("")}
            </table>
          </div>
        `).join("")}
      </div>
    `).join("")}
  `;
}

/* ===============================
   EVENTS
================================ */
termSelect.addEventListener("change", loadReport);

</script>

</body>
</html>
