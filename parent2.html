<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Term Report</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<style>

/* ================= BASE ================= */
*{
  box-sizing: border-box;
}

body{
  font-family: "Segoe UI", Roboto, Arial, sans-serif;
  background: linear-gradient(135deg,#eef2f8,#f8fafc);
  margin:0;
  padding:30px;
  color:#2c3e50;
}

/* ================= PAGE TITLE ================= */
h2{
  font-weight:600;
  margin-bottom:20px;
  color:#1f2d3d;
}

/* ================= FORM CARD ================= */
.form-card{
  background:#ffffff;
  padding:25px;
  border-radius:12px;
  box-shadow:0 10px 25px rgba(0,0,0,0.06);
  margin-bottom:25px;
  max-width:600px;
}

/* ================= INPUTS ================= */
input,select{
  width:100%;
  padding:10px 12px;
  margin-bottom:15px;
  border:1px solid #dcdfe6;
  border-radius:8px;
  font-size:14px;
  transition:all 0.2s ease;
}

input:focus,select:focus{
  outline:none;
  border-color:#1f6feb;
  box-shadow:0 0 0 3px rgba(31,111,235,0.1);
}

/* ================= BUTTON ================= */
button{
  padding:12px 20px;
  background:#1f6feb;
  color:white;
  border:none;
  border-radius:8px;
  font-weight:500;
  font-size:14px;
  cursor:pointer;
  transition:all 0.2s ease;
}

button:hover{
  background:#1558c0;
  transform:translateY(-1px);
  box-shadow:0 6px 15px rgba(31,111,235,0.2);
}

/* ================= STATUS ================= */
#status{
  font-weight:500;
  color:#e74c3c;
  margin-bottom:15px;
}

/* ================= REPORT CARD ================= */
.a4-page{
  background:#ffffff;
  padding:25px;
  border-radius:12px;
  box-shadow:0 15px 35px rgba(0,0,0,0.05);
  margin-bottom:30px;
}

/* ================= HEADER BLOCK ================= */
.learner-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
  padding-bottom:10px;
  border-bottom:1px solid #e5e9f2;
}

.learner-header h4{
  margin:0;
  font-weight:600;
  color:#1f2d3d;
}

/* ================= INSIGHT / SUMMARY ================= */
.split-block{
  background:#f4f7fb;
  padding:15px;
  border-radius:8px;
  margin-bottom:15px;
  font-size:14px;
}

/* ================= SUMMARY BOX ================= */
.summary-box{
  padding:15px;
  border-radius:8px;
  margin-bottom:15px;
  font-size:14px;
}

.summary-box ul{
  margin:8px 0 0 18px;
}

/* ================= SUBJECT BLOCK ================= */
.subject-block{
  margin-top:20px;
}

.subject-block h4{
  margin-bottom:8px;
  color:#1f2d3d;
}

/* ================= TABLE ================= */
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
  background:#fff;
  border-radius:8px;
  overflow:hidden;
}

th{
  background:#f1f4f9;
  text-align:left;
  padding:10px;
  font-weight:600;
  border-bottom:2px solid #e5e9f2;
}

td{
  padding:9px;
  border-bottom:1px solid #eef2f8;
}

tr:last-child td{
  border-bottom:none;
}

tr:hover{
  background:#f9fbff;
}

/* ================= RESPONSIVE ================= */
@media(max-width:768px){
  body{
    padding:15px;
  }
  .learner-header{
    flex-direction:column;
    align-items:flex-start;
    gap:6px;
  }
}

</style>
 
</head>

<body>

<h2>Student Report Lookup</h2>


<div class="form-card">
  <input id="yearInput" value="2026" placeholder="Year">
  <select id="termSelect"></select>
  <input id="firstInput" placeholder="First name">
  <input id="lastInput" placeholder="Last name">
  <input id="admInput" placeholder="Admission number">

  <p id="status"></p>

  <button onclick="downloadPDF()">Download Summary PDF</button>
</div>

  
<hr>

<div id="report"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
 "https://zcmzuetusvpmvubbjlmx.supabase.co",
 "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const termSelect = document.getElementById("termSelect");
const firstInput = document.getElementById("firstInput");
const lastInput  = document.getElementById("lastInput");
const admInput   = document.getElementById("admInput");
const yearInput  = document.getElementById("yearInput");
const reportDiv  = document.getElementById("report");
const status     = document.getElementById("status");

let results = [];
let avgMap = {};
  let overallInsight = "";
let strengthsMap = {};
let needsMap = {};
let supportFlag = "";


function levelToScore(level){
 if(level==="Below Expectations") return 1;
 if(level==="Approaching Expectations") return 2;
 if(level==="Meeting Expectations") return 3;
 if(level==="Exceeding Expectations") return 4;
 return 0;
}



function generateInsight(subjects){
  let total = 0, count = 0;
  Object.values(subjects).forEach(rows=>{
    rows.forEach(r=>{
      const s = levelToScore(r.achievement_level);
      if(s>0){ total+=s; count++; }
    });
  });

  if(!count) return "";
  const avg = total/count;

  if(avg>=3.5) return "Overall learner is exceeding expectations.";
  if(avg>=2.5) return "Overall learner is meeting expectations.";
  if(avg>=1.5) return "Overall learner is approaching expectations.";
  return "Overall learner is below expectations and needs support.";
}

function generateStrengthsAndNeeds(subjects){
  let strengths=[], needs=[];
  Object.entries(subjects).forEach(([subject,rows])=>{
    const scores = rows.map(r=>levelToScore(r.achievement_level)).filter(s=>s>0);
    if(!scores.length) return;
    const avg = scores.reduce((a,b)=>a+b,0)/scores.length;

    if(avg>=3.5) strengths.push(subject);
    if(avg<2.5) needs.push(subject);
  });
  return {strengths, needs};
}

function generateSupportFlag(strengths, needs){
  if(needs.length>=2) return "üî¥ Needs Learning Support";
  if(strengths.length>=2) return "üü¢ High Potential";
  return "üü° On Track";
}

  
/* LOAD TERMS */
const { data: terms } = await supabase.from("terms").select("id,name").order("name");
termSelect.innerHTML = `<option value="">Select term</option>` +
 terms.map(t=>`<option value="${t.name}">${t.name}</option>`).join("");

/* AUTO LOAD */
["firstInput","lastInput","admInput","termSelect"].forEach(id=>{
 document.getElementById(id).addEventListener("input", loadReport);
});

/* MAIN */


async function loadReport(){
  reportDiv.innerHTML = "";
  status.innerText = "";

  const term = termSelect.value;
  const first = firstInput.value.trim();
  const last = lastInput.value.trim();
  const adm = admInput.value.trim();
  const year = yearInput.value.trim();

  if(!term || !first || !last || !adm) return;

  const { data, error } = await supabase
    .from("assessment_results_view")
    .select("*")
    .eq("term", term)
    .eq("academic_year", year)
    .ilike("first_name", `%${first}%`)
    .ilike("last_name", `%${last}%`)
    .eq("admission_number", adm);

  if(error || !data.length){
    status.innerText = "No results found";
    return;
  }

  results = data;
  status.innerText = ""; // ‚úÖ clear message when report exists
  buildAverages();
  renderReport();
}

 
/* BUILD AVERAGES */
function buildAverages(){
 avgMap = {};
 results.forEach(r=>{
  const student = `${r.first_name} ${r.last_name}`;
  avgMap[student] ??= {};
  avgMap[student][r.subject] ??= {total:0,count:0};
  const score = levelToScore(r.achievement_level);
  avgMap[student][r.subject].total+=score;
  avgMap[student][r.subject].count++;
 });

 Object.keys(avgMap).forEach(s=>{
  Object.keys(avgMap[s]).forEach(sub=>{
   const d = avgMap[s][sub];
   const avg = d.total/d.count;
   avgMap[s][sub]={
    average_score:avg,
    level:
     avg>=3.5?"Exceeding Expectations":
     avg>=2.5?"Meeting Expectations":
     avg>=1.5?"Approaching Expectations":
     "Below Expectations"
   };
  });
 });
}



function generateRecommendations(strengths, needs) {

  let teacher = [];
  let parent = [];
  let learner = [];

  // üë©üèΩ‚Äçüè´ TEACHER ACTIONS
  if (strengths.length) {
    teacher.push(
      `Encourage learner through strengths in ${strengths.join(", ")}`
    );
  }

  if (needs.length) {
    teacher.push(
      `Provide targeted support in ${needs.join(", ")}`
    );
  }

  // üè† PARENT SUPPORT
  if (needs.length) {
    parent.push(
      `Support practice in ${needs.join(", ")} at home`
    );
  }

  parent.push("Maintain communication with class teacher");

  // üéØ LEARNER FOCUS
  if (strengths.length) {
    learner.push(
      `Build confidence by applying strengths in ${strengths.join(", ")}`
    );
  }

  if (needs.length) {
    learner.push(
      `Focus revision on ${needs.join(", ")}`
    );
  }

  learner.push("Ask for help when concepts are unclear");

  return { teacher, parent, learner };
}
 
 
/* RENDER */

function renderReport() {
  if (!results.length) return;

  const student = `${results[0].first_name} ${results[0].last_name}`;
  const adm = results[0].admission_number;
  const className = results[0].class_name || "‚Äî";
  const schoolName = results[0].school_name || "‚Äî";
  const term = termSelect.value || "‚Äî";
  const year = yearInput.value || "‚Äî";

  // Prepare subjects object
  const subjects = {};
  results.forEach(r => {
    subjects[r.subject] ??= [];
    subjects[r.subject].push(r);
  });

  // Insights and recommendations
  overallInsight = generateInsight(subjects);
  const sn = generateStrengthsAndNeeds(subjects);
  strengthsMap = sn.strengths;
  needsMap = sn.needs;
  supportFlag = generateSupportFlag(strengthsMap, needsMap);


const recommendations = generateRecommendations(strengthsMap, needsMap);


 
  let html = `<div class="a4-page learner-page">
    <div class="learner-card">

      <!-- SCHOOL & TERM HEADER -->
      <div class="report-overview no-split">
        <h3>${schoolName}</h3>
        <div class="learner-meta">
          <strong>Class:</strong> ${className} &nbsp; | &nbsp;
          <strong>Term:</strong> ${term} ‚Äì ${year}
        </div>
      </div>

      <!-- STUDENT HEADER -->
      <div class="learner-header">
        <h4>üë§ ${student} <small>(Adm: ${adm})</small></h4>
        <div style="font-weight:bold;">${supportFlag}</div>
      </div>

      <!-- OVERALL INSIGHT -->
      <div class="split-block" style="margin-bottom:10px;">
        ${overallInsight ? `<p><strong>üìã Insight:</strong> ${overallInsight}</p>` : ""}
        ${strengthsMap.length ? `<p><strong>üí™ Strengths:</strong> ${strengthsMap.join(", ")}</p>` : ""}
        ${needsMap.length ? `<p><strong>üéØ Areas for Improvement:</strong> ${needsMap.join(", ")}</p>` : ""}
      </div>

      <!-- RECOMMENDATIONS -->
      ${recommendations.teacher.length ? `
        <div class="summary-box" style="border-left:4px solid #3498db;background:#f3f6fa;">
          <strong>üë©üèΩ‚Äçüè´ Teacher Actions</strong>
          <ul>${recommendations.teacher.map(r => `<li>${r}</li>`).join("")}</ul>
        </div>` : ""}
      ${recommendations.parent.length ? `
        <div class="summary-box" style="border-left:4px solid #f39c12;background:#fffaf3;">
          <strong>üè† Parent Support</strong>
          <ul>${recommendations.parent.map(r => `<li>${r}</li>`).join("")}</ul>
        </div>` : ""}
      ${recommendations.learner.length ? `
        <div class="summary-box" style="border-left:4px solid #2ecc71;background:#f6fffa;">
          <strong>üéØ Learner Focus</strong>
          <ul>${recommendations.learner.map(r => `<li>${r}</li>`).join("")}</ul>
        </div>` : ""}

      <!-- SUBJECT TABLES -->
      ${Object.entries(avgMap[student] || {}).map(([subject, d]) => {
        const rows = results.filter(r => r.subject === subject);
        return `
        <div class="subject-block">
          <h4>${subject}</h4>
          <table>
            <thead>
              <tr><th>Competency</th><th>Level</th></tr>
            </thead>
            <tbody>
              ${rows.map(r => `<tr><td>${r.competency || "‚Äî"}</td><td>${r.achievement_level || "‚Äî"}</td></tr>`).join("")}
              <tr style="font-weight:bold">
                <td>AVERAGE</td>
                <td>${d.average_score ? d.average_score.toFixed(2) : "N/A"} ‚Äî ${d.level || "N/A"}</td>
              </tr>
            </tbody>
          </table>
        </div>`;
      }).join("")}

    </div>
  </div>`;

  reportDiv.innerHTML = html;
}



 
/* PDF */
window.downloadPDF = ()=>{
 if(!reportDiv.innerHTML.trim()) return alert("No report");
 html2pdf().from(reportDiv).set({
  filename:"Summary_Report.pdf",
  jsPDF:{unit:"mm",format:"a4"}
 }).save();
}
</script>
</body>
</html>
