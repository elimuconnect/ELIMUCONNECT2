<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const reportDiv = document.getElementById("report");
const statusEl = document.getElementById("status");
const actionBox = document.getElementById("actionBox");

const admissionInput = document.getElementById("admission");
const firstNameInput = document.getElementById("firstName");
const lastNameInput = document.getElementById("lastName");

function levelClass(level){
  if(level==="Below Expectations") return "below";
  if(level==="Approaching Expectations") return "approaching";
  if(level==="Meeting Expectations") return "meeting";
  return "exceeding";
}

// AUTO LOAD
admissionInput.addEventListener("input", autoLoad);
firstNameInput.addEventListener("input", autoLoad);
lastNameInput.addEventListener("input", autoLoad);

// OPTIONAL button still works
document.getElementById("checkBtn").onclick = autoLoad;

async function autoLoad(){
  const admission = admissionInput.value.trim();
  const first = firstNameInput.value.trim();
  const last = lastNameInput.value.trim();

  if(admission.length < 2 || first.length < 2 || last.length < 2){
    return; // wait until real data
  }

  statusEl.innerText = "Checking resultsâ€¦";
  reportDiv.innerHTML = "";
  actionBox.style.display="none";

  const { data, error } = await supabase
    .from("public_parent_results")
    .select("*")
    .eq("admission_number", admission)
    .ilike("first_name", first)
    .ilike("last_name", last)
    .order("learning_area");

  if(error){ statusEl.innerText=error.message; return; }
  if(!data.length){ statusEl.innerText="No records found."; return; }

  statusEl.innerText="";
  actionBox.style.display="block";

  const student = `${data[0].first_name} ${data[0].last_name}`;
  const term = data[0].term;
  const year = data[0].academic_year;

  const grouped = {};
  data.forEach(r=>{
    grouped[r.learning_area] ??= [];
    grouped[r.learning_area].push(r);
  });

  reportDiv.innerHTML = `
  <div class="a4-page">
    <div class="header">
      <h3>${student}</h3>
      <div class="muted">
        Adm: ${admission} |
        Term: ${term} |
        Year: ${year}
      </div>
    </div>

    ${Object.entries(grouped).map(([subject, rows])=>`
      <h4>ðŸ“˜ ${subject}</h4>
      <table>
        <thead>
          <tr>
            <th>Competency</th>
            <th>Achievement</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r=>`
            <tr class="${levelClass(r.achievement_level)}">
              <td>${r.competency}</td>
              <td>${r.achievement_level}</td>
              <td>${r.remarks||""}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `).join("")}
  </div>`;
}

window.downloadPDF = function(){
  const opt = {
    margin: 5,
    filename: "Parent_Summary_Report.pdf",
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(reportDiv).save();
};
</script>
