<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const SYSTEM_YEAR = 2026;
document.getElementById("yearLabel").innerText = SYSTEM_YEAR;

// ✅ Get selections from previous page
const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year") || SYSTEM_YEAR;

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href = "teacher-dashboard.html";
}

// ----------------------
// 0️⃣ Auth & profile
// ----------------------
const { data: { user }, error: userError } = await supabase.auth.getUser();
if (!user) {
  window.location.href = "index.html";
  throw new Error("Not logged in");
}

// Fetch full profile to get school_id
const { data: profile, error: profileError } = await supabase
  .from("profiles")
  .select("id, full_name, role, school_id")
  .eq("auth_id", user.id)
  .single();

if (profileError) throw profileError;

const schoolId = profile.school_id;
if (!schoolId) throw new Error("Cannot determine school_id. Ensure your profile has a school assigned.");

// ----------------------
// 1️⃣ Display class & subject names
// ----------------------
const { data: classData } = await supabase.from("classes").select("name").eq("id", classId).single();
const { data: subjectData } = await supabase.from("subjects").select("name").eq("id", subjectId).single();
document.getElementById("classLabel").innerText = classData?.name || "N/A";
document.getElementById("subjectLabel").innerText = subjectData?.name || "N/A";

// ----------------------
// 2️⃣ Load terms, assessment types & levels
// ----------------------
const { data: terms } = await supabase.from("terms").select("id, name");
const termSelect = document.getElementById("termSelect");

termSelect.innerHTML = `
  <option value="" disabled selected>-- Select Term --</option>
  ${terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("")}
`;

const { data: assessmentTypes } = await supabase.from("assessment_types").select("id, name");
const { data: levels } = await supabase.from("achievement_levels").select("id, label").order("order_rank");

// ----------------------
// 3️⃣ Load students
// ----------------------
const { data: students } = await supabase
  .from("students")
  .select("id, admission_number, first_name, last_name")
  .eq("class_id", classId)
  .order("last_name");

const tbody = document.getElementById("studentsBody");
if (!students?.length) {
  tbody.innerHTML = `<tr><td colspan="4">No students in this class</td></tr>`;
} else {
  tbody.innerHTML = students.map(s => `
<tr data-id="${s.id}">
  <td>${s.admission_number || ""}</td>
  <td>${s.first_name} ${s.last_name}</td>
  <td>
    <select class="assessmentType">
      ${assessmentTypes.map(a=>`<option value="${a.id}">${a.name}</option>`).join("")}
    </select>
  </td>
  <td>
    <select class="performanceLevel">
      <option value="">Select Level</option>
      ${levels.map(l=>`<option value="${l.id}">${l.label}</option>`).join("")}
    </select>
  </td>
</tr>
`).join("");
}

// ----------------------
// 4️⃣ Save assessment
// ----------------------
document.getElementById("saveAssessment").onclick = async () => {
  const termId = termSelect.value;
  const strand = document.getElementById("strandInput").value;
  const substrand = document.getElementById("substrandInput").value;

  if (!termId) {
    document.getElementById("status").innerText = "Please select a term.";
    return;
  }

  // ✅ 4a: create the assessment first
  const { data: assessment, error: assessmentError } = await supabase
    .from("assessments")
    .insert([{
      class_id: classId,
      subject_id: subjectId,
      school_id: schoolId,
      term_id: termId,
      academic_year: academicYear,
      created_by: user.id
    }])
    .select()
    .single();

  if (assessmentError) {
    document.getElementById("status").innerText = `Error creating assessment: ${assessmentError.message}`;
    return;
  }

  const assessmentId = assessment.id;

  // ✅ 4b: prepare rows for assessment_results
  const rows = Array.from(document.querySelectorAll("#studentsBody tr")).map(tr => ({
    assessment_id: assessmentId,
    student_id: tr.dataset.id,
    subject_id: subjectId,       
    term_id: termId,
    assessment_type_id: tr.querySelector(".assessmentType").value,
    achievement_level_id: tr.querySelector(".performanceLevel").value,
    strand,
    substrand,
    academic_year: academicYear,
    teacher_id: user.id,
    created_by: user.id
  }));

  // ✅ 4c: insert results
  const { error: insertError } = await supabase.from("assessment_results").insert(rows);

  document.getElementById("status").innerText = insertError 
    ? `Error saving: ${insertError.message}` 
    : "Assessment and results saved successfully!";
};
</script>
