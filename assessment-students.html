<!DOCTYPE html>
<html>
<head>
  <title>Select Students</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>Select Students for Assessment</h2>

<p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>

<div id="studentList">Loading students...</div>
<br>
<button id="confirmStudents">Confirm Students</button>

<p id="status"></p>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  /* ðŸ”’ SYSTEM YEAR */
  const SYSTEM_YEAR = 2026;

  /* 0ï¸âƒ£ Auth check */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    throw new Error("Not logged in");
  }

  /* 1ï¸âƒ£ Load required context */
  const assessmentId = localStorage.getItem("assessment_id");
  const classId = localStorage.getItem("class_id");
  const storedYear = localStorage.getItem("academic_year");

  if (!assessmentId || !classId) {
    window.location.href = "teacher.html";
    throw new Error("Missing assessment or class");
  }

  /* ðŸ”’ Lock academic year */
  const academicYear = storedYear || SYSTEM_YEAR;
  localStorage.setItem("academic_year", academicYear);
  document.getElementById("yearLabel").innerText = academicYear;

  /* 2ï¸âƒ£ Load students */
  const { data: students, error: studentError } = await supabase
    .from("students")
    .select("id, first_name, last_name")
    .eq("class_id", classId)
    .order("last_name");

  if (studentError) {
    status.innerText = studentError.message;
    throw studentError;
  }

  if (!students.length) {
    studentList.innerText = "No students found in this class.";
    throw new Error("No students");
  }

  /* Render checklist */
  studentList.innerHTML = students.map(s => `
    <label>
      <input type="checkbox" value="${s.id}">
      ${s.first_name} ${s.last_name}
    </label><br>
  `).join("");

  /* 3ï¸âƒ£ Confirm students */
  confirmStudents.onclick = () => {
    const selected = Array.from(
      document.querySelectorAll("input[type=checkbox]:checked")
    ).map(cb => cb.value);

    if (!selected.length) {
      status.innerText = "Please select at least one student.";
      return;
    }

    localStorage.setItem("selected_students", JSON.stringify(selected));

    /* âœ… Academic year is already locked and carried */
    window.location.href = "new-assessment.html";
  };
</script>

</body>
</html>
