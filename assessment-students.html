<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Assessment Students</title>
</head>
<body>

<h2>Students for Assessment</h2>
<p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>
<p><strong>Subject:</strong> <span id="subjectLabel"></span></p>
<div id="studentList">Loading students...</div>
<br>
<button id="confirmStudents">Confirm Students</button>
<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const { data: { user } } = await supabase.auth.getUser();
if (!user) { window.location.href = "index.html"; throw new Error("Not logged in"); }

const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year");

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href = "teacher-dashboard.html";
}

document.getElementById("yearLabel").innerText = academicYear;

// Load subject name
const { data: subject } = await supabase
  .from("subjects")
  .select("name")
  .eq("id", subjectId)
  .single();
document.getElementById("subjectLabel").innerText = subject?.name || "N/A";

// Load students
const { data: students } = await supabase
  .from("students")
  .select("id, first_name, last_name, admission_number")
  .eq("class_id", classId)
  .order("last_name");

const studentList = document.getElementById("studentList");

if (!students?.length) {
  studentList.innerText = "No students found for this class.";
} else {
  studentList.innerHTML = students.map(s => `
    <label>
      <input type="checkbox" value="${s.id}">
      ${s.admission_number || ""} - ${s.first_name} ${s.last_name}
    </label><br>
  `).join("");
}

document.getElementById("confirmStudents").onclick = () => {
  const selected = Array.from(document.querySelectorAll("input[type=checkbox]:checked")).map(cb => cb.value);
  if (!selected.length) {
    document.getElementById("status").innerText = "Please select at least one student.";
    return;
  }
  localStorage.setItem("selected_students", JSON.stringify(selected));
  window.location.href = "new-assessment.html"; // Next step page
};
</script>
</body>
</html>
