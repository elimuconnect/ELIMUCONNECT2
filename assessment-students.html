<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Assessment Students</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  select { width: 100%; }
  button { margin-top: 15px; padding: 8px 12px; cursor: pointer; }
</style>
</head>
<body>

<h2>New Assessment Table</h2>

<p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>
<p><strong>Class:</strong> <span id="classLabel"></span></p>
<p><strong>Subject:</strong> <span id="subjectLabel"></span></p>

<p>
  <label>Term:</label>
  <select id="termSelect"></select>
</p>
<p>
  <label>Strand(s):</label>
  <input type="text" id="strandInput" placeholder="Enter strand(s)">
</p>
<p>
  <label>Substrand (optional):</label>
  <input type="text" id="substrandInput" placeholder="Enter substrand">
</p>

<table>
  <thead>
    <tr>
      <th>Adm/Assess NO.</th>
      <th>Name</th>
      <th>Assessment Type</th>
      <th>Performance Level</th>
    </tr>
  </thead>
  <tbody id="studentsBody">
    <tr><td colspan="4">Loading students...</td></tr>
  </tbody>
</table>

<br>
<button id="saveAssessment">Save Assessment</button>
<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const SYSTEM_YEAR = 2026;
document.getElementById("yearLabel").innerText = SYSTEM_YEAR;

// ✅ Get selections from previous page
const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year") || SYSTEM_YEAR;

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href = "teacher-dashboard.html";
}

// Display class and subject names
const { data: classData } = await supabase.from("classes").select("name").eq("id", classId).single();
const { data: subjectData } = await supabase.from("subjects").select("name").eq("id", subjectId).single();
document.getElementById("classLabel").innerText = classData?.name || "N/A";
document.getElementById("subjectLabel").innerText = subjectData?.name || "N/A";

// Load terms
const { data: terms } = await supabase.from("terms").select("id, name");

const termSelect = document.getElementById("termSelect");

termSelect.innerHTML = `
  <option value="" disabled selected>-- Select Term --</option>
  ${terms.map(t => `
    <option value="${t.id}">${t.name}</option>
  `).join("")}
`;
// Load assessment types & achievement levels
const { data: assessmentTypes } = await supabase.from("assessment_types").select("id, name");
const { data: levels } = await supabase.from("achievement_levels").select("id, label").order("order_rank");

// Load students for the selected class
const { data: students } = await supabase
  .from("students")
  .select("id, admission_number, first_name, last_name")
  .eq("class_id", classId)
  .order("last_name");

const tbody = document.getElementById("studentsBody");
if (!students?.length) {
  tbody.innerHTML = `<tr><td colspan="4">No students in this class</td></tr>`;
} else {
  tbody.innerHTML = students.map(s => `
<tr data-id="${s.id}">
  <td>${s.admission_number || ""}</td>
  <td>${s.first_name} ${s.last_name}</td>
  <td>
    <select class="assessmentType">
      ${assessmentTypes.map(a=>`<option value="${a.id}">${a.name}</option>`).join("")}
    </select>
  </td>
  <td>
    <select class="performanceLevel">
      <option value="">Select Level</option>
      ${levels.map(l=>`<option value="${l.id}">${l.label}</option>`).join("")}
    </select>
  </td>
</tr>
`).join("");
}

// Save assessment
document.getElementById("saveAssessment").onclick = async () => {
  const termId = document.getElementById("termSelect").value;
  const strand = document.getElementById("strandInput").value;
  const substrand = document.getElementById("substrandInput").value;


const { data: { user } } = await supabase.auth.getUser();
if (!user) { window.location.href = "index.html"; throw new Error("Not logged in"); }

// ... later, inside saveAssessment:
const rows = Array.from(document.querySelectorAll("#studentsBody tr")).map(tr => ({
  assessment_id: null,
  student_id: tr.dataset.id,
  subject_id: subjectId,       
  term_id: termId,
  assessment_type_id: tr.querySelector(".assessmentType").value,
  achievement_level_id: tr.querySelector(".performanceLevel").value,
  strand,
  substrand,
  academic_year: academicYear,
  teacher_id: user.id,        // ✅ reuse the user object
  created_by: user.id
}));
  
  const { error } = await supabase.from("assessment_results").insert(rows);
  document.getElementById("status").innerText = error ? `Error saving: ${error.message}` : "Assessment saved successfully!";
};

  console.log("Stored class_id:", localStorage.getItem("class_id"));
console.log("Stored subject_id:", localStorage.getItem("subject_id"));
console.log("Stored academic_year:", localStorage.getItem("academic_year"));
</script>

</body>
</html>
