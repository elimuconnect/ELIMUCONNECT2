<!DOCTYPE html>
<html>
<head>
  <title>Parent Dashboard</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>My Children</h2>

<div id="childrenTabs"></div>

<hr>

<label>Academic Year</label>
<select id="yearSelect"></select>

<label>Term</label>
<select id="termSelect">
  <option value="">All Terms</option>
  <option value="Term 1">Term 1</option>
  <option value="Term 2">Term 2</option>
  <option value="Term 3">Term 3</option>
</select>

<hr>

<div id="results"></div>
<p id="status"></p>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  const supabase = createClient(
    "https://zcmzuetusvpmvubbjlmx.supabase.co",
    "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
  );

  /* Auth */
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) location.href = "index.html";

  /* Load dashboard data */
  const { data, error } = await supabase
    .from("parent_assessment_dashboard")
    .select("*")
    .order("academic_year", { ascending: false });

  if (error) {
    document.getElementById("status").innerText = error.message;
    throw error;
  }



let currentStudentId = null;



  
  /* Group by child */
  const children = {};
  data.forEach(r => {
    if (!children[r.student_id]) {
      children[r.student_id] = {
        name: r.student_name,
        records: []
      };
    }
    children[r.student_id].records.push(r);
  });

  /* Render child tabs */
  const tabs = document.getElementById("childrenTabs");
  Object.entries(children).forEach(([id, child], index) => {
    const btn = document.createElement("button");
    btn.innerText = child.name;

btn.onclick = () => {
  currentStudentId = id;
  renderResults();
};

if (index === 0) {
  currentStudentId = id;
  renderResults();
}


    
    tabs.appendChild(btn);
  });

  /* Populate years */
  const years = [...new Set(data.map(r => r.academic_year))];
  document.getElementById("yearSelect").innerHTML =
    years.map(y => `<option value="${y}">${y}</option>`).join("");

 document.getElementById("yearSelect").onchange =
document.getElementById("termSelect").onchange = () => {
  if (currentStudentId) {
    renderResults();
  }
};


  function renderResults() {
  document.querySelectorAll("#childrenTabs button")
    .forEach(b => b.classList.remove("active"));

  [...document.querySelectorAll("#childrenTabs button")]
    .find(b => b.innerText === children[currentStudentId].name)
    ?.classList.add("active");

  const year = document.getElementById("yearSelect").value;
  const term = document.getElementById("termSelect").value;



const records = children[currentStudentId].records.filter(r =>
  (!year || String(r.academic_year) === year) &&
  (!term || r.term === term)
);


    
  const container = document.getElementById("results");

  if (!records.length) {
    container.innerHTML = "<p>No records found.</p>";
    return;
  }

  container.innerHTML = records.map(r => `
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
      <strong>${r.learning_area}</strong><br>
      ${r.competency}<br>
      <b>${r.achievement_level}</b><br>
      <i>${r.remarks || ""}</i>
    </div>
  `).join("");
}

</script>

</body>
</html>
