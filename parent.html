<!DOCTYPE html>
<html>
<head>
  <title>Parent Dashboard</title>
  <meta charset="UTF-8" />
</head>
<body>

<h2>My Children</h2>

<div id="childrenTabs"></div>

<hr>

<label>Academic Year</label>
<select id="yearSelect"></select>

<label>Term</label>
<select id="termSelect">
  <option value="">All Terms</option>
  <option value="Term 1">Term 1</option>
  <option value="Term 2">Term 2</option>
  <option value="Term 3">Term 3</option>
</select>

<hr>

<div id="results"></div>
<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

/* ───────── AUTH ───────── */
const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "index.html";

/* ───────── LOAD DATA ───────── */
const { data, error } = await supabase
  .from("parent_assessment_dashboard")
  .select("*");

if (error) {
  document.getElementById("status").innerText = error.message;
  throw error;
}

/* ───────── NORMALIZE DATA ───────── */
data.forEach(r => {
  r.academic_year = String(r.academic_year); // force string once
});

/* ───────── GROUP BY CHILD ───────── */
const children = {};
data.forEach(r => {
  if (!children[r.student_id]) {
    children[r.student_id] = {
      name: r.student_name,
      records: []
    };
  }
  children[r.student_id].records.push(r);
});

/* ───────── STATE ───────── */
let currentStudentId = null;

/* ───────── CHILD TABS ───────── */
const tabs = document.getElementById("childrenTabs");

Object.entries(children).forEach(([id, child], index) => {
  const btn = document.createElement("button");
  btn.textContent = child.name;

  btn.onclick = () => {
    currentStudentId = id;
    renderResults();
  };

  tabs.appendChild(btn);

  if (index === 0) currentStudentId = id;
});

/* ───────── YEAR SELECT ───────── */
const yearSelect = document.getElementById("yearSelect");
const years = [...new Set(data.map(r => r.academic_year))].sort().reverse();

yearSelect.innerHTML =
  `<option value="">All Years</option>` +
  years.map(y => `<option value="${y}">${y}</option>`).join("");

/* ───────── FILTER EVENTS ───────── */
yearSelect.onchange =
document.getElementById("termSelect").onchange = () => {
  renderResults();
};

/* ───────── RENDER ───────── */
function renderResults() {
  if (!currentStudentId) return;

  // Highlight active tab
  [...tabs.children].forEach(b => b.classList.remove("active"));
  [...tabs.children]
    .find(b => b.textContent === children[currentStudentId].name)
    ?.classList.add("active");

  const year = yearSelect.value;
  const term = document.getElementById("termSelect").value;

  const records = children[currentStudentId].records.filter(r =>
    (!year || r.academic_year === year) &&
    (!term || r.term === term)
  );

  const container = document.getElementById("results");

  if (!records.length) {
    container.innerHTML = "<p>No records found.</p>";
    return;
  }

  container.innerHTML = records.map(r => `
    <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
      <strong>${r.learning_area}</strong><br>
      ${r.competency}<br>
      <b>${r.achievement_level}</b><br>
      <i>${r.remarks || ""}</i>
    </div>
  `).join("");
}

/* Initial render */
renderResults();
</script>

</body>
</html>
