<!DOCTYPE html>
<html>
<head>
  <title>Link Child</title>
</head>
<body>

<h2>Link a Child</h2>

<label>Admission Number</label><br>
<input id="admission" /><br><br>

<button id="linkChild">Link</button>

<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const { data: { user } } = await supabase.auth.getUser();
if (!user) location.href = "index.html";

/* Get parent profile */
const { data: profile } = await supabase
  .from("profiles")
  .select("id")
  .eq("auth_id", user.id)
  .single();

document.getElementById("linkChild").onclick = async () => {
  const admission = document.getElementById("admission").value.trim();
  if (!admission) return;

  /* Find student */
  const { data: student, error } = await supabase
    .from("students")
    .select("id")
    .eq("admission_number", admission)
    .single();

  if (error || !student) {
    document.getElementById("status").innerText = "Student not found";
    return;
  }

  /* Link */
  const { error: linkError } = await supabase
    .from("parent_learners")
    .insert({
      parent_profile_id: profile.id,
      learner_id: student.id
    });

  if (linkError) {
    document.getElementById("status").innerText = linkError.message;
    return;
  }

  document.getElementById("status").innerText =
    "Child linked successfully.";
};
</script>

</body>
</html>
