<!DOCTYPE html> 
<html>
<head>
<meta charset="UTF-8">
<title>Assessment Students</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  select, input { width: 100%; padding: 4px; }
  button { margin-top: 15px; padding: 8px 12px; cursor: pointer; }
  .competency-section { margin-top: 20px; }
  .competency-checkbox { display: block; margin-bottom: 6px; cursor: pointer; }
  .competency-checkbox input { margin-right: 6px; }



  /* Dropdown container */
.dropdown {
  position: relative;
  display: inline-block;
  width: 100%;
}

.dropdown-content {
  display: none;
  position: absolute;
  background-color: #f9f9f9;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid #ccc;
  z-index: 1;
  padding: 10px;
}

.dropdown-content label {
  display: block;
  cursor: pointer;
  margin-bottom: 6px;
}

.dropdown-content input {
  margin-right: 6px;
}

#dropdownBtn {
  width: 100%;
  padding: 6px;
  text-align: left;
  cursor: pointer;
}
</style>
</head>
<body>
<h2>New Assessment Table</h2>

<p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>
<p><strong>Class:</strong> <span id="classLabel"></span></p>
<p><strong>Subject:</strong> <span id="subjectLabel"></span></p>
<p id="assessmentStatus" style="font-weight:bold; color:blue;"></p>
<p>
  <label>Term:</label>
  <select id="termSelect"></select>
</p>

<p>
  <label>Assessment Type:</label>
  <select id="assessmentTypeSelect"></select>
</p>

<!-- Core Competencies -->
<div class="competency-section">
  <label><strong>Core Competencies:</strong></label>
  <div class="dropdown">
    <button type="button" id="dropdownBtn">Select Core Competencies â–¼</button>
    <div id="coreCompetenciesContainer" class="dropdown-content"></div>
  </div>
</div>

<!-- Subject-specific manual input -->
<div class="competency-section">
  <label>Subject-specific Competencies (manual input):</label>
  <input type="text" id="subjectCompetency" 
         placeholder="Enter subject-specific competencies, comma-separated">
</div>

<!-- Strand -->
<div class="competency-section">
  <label><strong>Strands:</strong></label>
  <div class="dropdown">
    <button type="button" id="dropdownStrandBtn">Select Strands â–¼</button>
    <div id="strandContainer" class="dropdown-content"></div>
  </div>
</div>

<!-- Specific Learning Experience -->
<div class="competency-section">
  <label><strong>Learning Experiences:</strong></label>
  <div class="dropdown">
    <button type="button" id="dropdownSLEBtn">Select Learning Experiences â–¼</button>
    <div id="sleContainer" class="dropdown-content"></div>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th>Adm/Assess NO.</th>
      <th>Name</th>
      <th>Performance Level</th>
    </tr>
  </thead>
  <tbody id="studentsBody">
    <tr><td colspan="3">Loading students...</td></tr>
  </tbody>
</table>

<br>
<button id="saveAssessment">Save Assessment</button>
<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const SYSTEM_YEAR = 2026;
document.getElementById("yearLabel").innerText = SYSTEM_YEAR;

const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year") || SYSTEM_YEAR;

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href="teacher-dashboard.html";
}

// Display class and subject
const { data: classData } = await supabase.from("classes").select("name").eq("id", classId).single();
const { data: subjectData } = await supabase.from("subjects").select("name").eq("id", subjectId).single();
document.getElementById("classLabel").innerText = classData?.name || "N/A";
document.getElementById("subjectLabel").innerText = subjectData?.name || "N/A";

// Load terms
const { data: terms } = await supabase.from("terms").select("id, name");
document.getElementById("termSelect").innerHTML = `<option value="" disabled selected>-- Select Term --</option>${terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("")}`;

// Load assessment types
const { data: assessmentTypes } = await supabase.from("assessment_types").select("id, name");
document.getElementById("assessmentTypeSelect").innerHTML = `<option value="" disabled selected>-- Select Assessment Type --</option>${assessmentTypes.map(a => `<option value="${a.id}">${a.name}</option>`).join("")}`;

// Auto-check on page load after terms/types are loaded
loadExistingAssessment();

  
// Load achievement levels
const { data: levels } = await supabase
  .from("achievement_levels")
  .select("id, label")
  .order("order_index", { ascending: true });
// Load competencies and populate top core competencies
const { data: competencies } = await supabase.from("competencies").select("id, name, subject_id").or("is_active.is.null,is_active.eq.true").order("name");
const coreContainer = document.getElementById("coreCompetenciesContainer");

competencies
  .filter(c => !c.subject_id)   // Only global core competencies
  .forEach(c => {
    const label = document.createElement("label");
    label.className = "competency-checkbox";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = c.id;
    checkbox.className = "coreCompetency";
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(c.name));
    coreContainer.appendChild(label);
  });

// Load students
const { data: students } = await supabase.from("students").select("id, admission_number, first_name, last_name").eq("class_id", classId).order("last_name");
const tbody = document.getElementById("studentsBody");
if (!students?.length) tbody.innerHTML = `<tr><td colspan="3">No students in this class</td></tr>`;
else tbody.innerHTML = students.map(s => `
<tr data-id="${s.id}">
  <td>${s.admission_number || ""}</td>
  <td>${s.first_name} ${s.last_name}</td>
  <td>
    <select class="performanceLevel">
      <option value="" disabled selected>Select Level</option>
      ${levels.map(l => `<option value="${l.id}">${l.label}</option>`).join("")}
    </select>
  </td>
</tr>`).join("");

// Load strands and sub-strands from DB
// Containers
const strandContainer = document.getElementById("strandContainer");
const sleContainer = document.getElementById("sleContainer");

// Load strands for the selected subject
const { data: strands } = await supabase.from("strands")
  .select("id, name")
  .eq("subject_id", subjectId)
  .eq("grade", 10)
  .order("name");

// Populate strands as checkboxes
strands.forEach(s => {
  const label = document.createElement("label");
  label.className = "competency-checkbox";
  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.value = s.id;
  checkbox.className = "strandCheckbox";
  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(s.name));
  strandContainer.appendChild(label);
});

// When strands are selected, load SLEs dynamically
strandContainer.addEventListener("change", async () => {
  const selectedStrands = Array.from(document.querySelectorAll(".strandCheckbox:checked")).map(cb => cb.value);
  
  sleContainer.innerHTML = ""; // clear previous SLEs

  if (selectedStrands.length === 0) return;

  for (let strandId of selectedStrands) {
    const { data: sles } = await supabase.from("learning_experiences")
      .select("id, name")
      .eq("strand_id", strandId)
      .order("name");

    sles.forEach(sle => {
      const label = document.createElement("label");
      label.className = "competency-checkbox";
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = sle.id;
      checkbox.className = "sleCheckbox";
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(`${sle.name} (${strands.find(st => st.id == strandId).name})`));
      sleContainer.appendChild(label);
    });
  }
});

// Save assessment
// Save assessment
document.getElementById("saveAssessment").onclick = async () => {

const selectedStrands = Array.from(document.querySelectorAll(".strandCheckbox:checked")).map(cb => cb.value);
const selectedSLEs = Array.from(document.querySelectorAll(".sleCheckbox:checked")).map(cb => cb.value);

if (!selectedStrands.length) {
  alert("Please select at least one strand.");
  return;
}


  
  const termId = document.getElementById("termSelect").value;
  const termName = document.getElementById("termSelect").selectedOptions[0]?.text;
  const assessmentTypeId = document.getElementById("assessmentTypeSelect").value;

  const selectedCoreCompetencies = Array.from(
    document.querySelectorAll(".coreCompetency:checked")
  ).map(cb => cb.value);

  // âœ… Save as plain text (comma-separated)
  const subjectCompetency = document.getElementById("subjectCompetency").value.trim();

  if (!termId || !assessmentTypeId) {
  alert("Please select Term and Assessment Type before saving.");
  return;
}

  if (!selectedCoreCompetencies.length) {
    alert("Please select at least one core competency before saving.");
    return;
  }

  const studentRows = document.querySelectorAll("#studentsBody tr");
  let missingLevel = false;

  for (let row of studentRows) {
    const levelSelect = row.querySelector(".performanceLevel");
    if (!levelSelect) continue;

    const level = levelSelect.value;
    row.style.backgroundColor = "";

    if (!level) {
      missingLevel = true;
      row.style.backgroundColor = "rgba(255,0,0,0.2)";
    }

    levelSelect.onchange = () => row.style.backgroundColor = "";
  }

  if (missingLevel) {
    alert("Some students are missing a Performance Level.");
    return;
  }

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "index.html";
    return;
  }

  const { data: profile } = await supabase
    .from("profiles")
    .select("school_id")
    .eq("auth_id", user.id)
    .single();

  if (!profile?.school_id) {
    alert("Cannot determine school_id");
    return;
  }

  const schoolId = profile.school_id;
  const today = new Date().toISOString();
  const assessmentTitle = `${subjectData.name} - ${termName} (${academicYear})`;

  // ðŸ”Ž Check if similar assessment exists
  const { data: existingAssessment } = await supabase
    .from("assessments")
    .select("*")
    .eq("class_id", classId)
    .eq("subject_id", subjectId)
    .eq("term_id", termId)
    .eq("assessment_type_id", assessmentTypeId)
    .eq("academic_year", academicYear)
    .order("created_at", { ascending: false })
    .limit(1)
    .maybeSingle();

let assessmentId;

if (existingAssessment) {

  const createdDate = new Date(existingAssessment.created_at);
  const now = new Date();

  const diffDays = Math.floor(
    (now - createdDate) / (1000 * 60 * 60 * 24)
  );

  const EDIT_WINDOW_DAYS = 14;

  if (diffDays <= EDIT_WINDOW_DAYS) {

    // âœ… Update existing
    assessmentId = existingAssessment.id;

    await supabase.from("assessments")
      .update({
        core_competencies: selectedCoreCompetencies,
        subject_competencies: subjectCompetency
      })
      .eq("id", assessmentId);

  } else {

    // âœ… Create NEW (after 14 days)
    const { data: newAssessment, error } = await supabase
      .from("assessments")
      .insert([{
        title: assessmentTitle,
        class_id: classId,
        subject_id: subjectId,
        learning_area_id: subjectId,
        school_id: schoolId,
        term_id: termId,
        academic_year: academicYear,
        assessment_type_id: assessmentTypeId,
        assessment_date: today,
        created_by: user.id,
        core_competencies: selectedCoreCompetencies,
        subject_competencies: subjectCompetency
      }])
      .select()
      .single();

    if (error) {
      document.getElementById("status").innerText = error.message;
      return;
    }

    assessmentId = newAssessment.id;
  }

} else {

  // ðŸ†• FIRST TIME EVER â†’ create assessment
  const { data: newAssessment, error } = await supabase
    .from("assessments")
    .insert([{
      title: assessmentTitle,
      class_id: classId,
      subject_id: subjectId,
      learning_area_id: subjectId,
      school_id: schoolId,
      term_id: termId,
      academic_year: academicYear,
      assessment_type_id: assessmentTypeId,
      assessment_date: today,
      created_by: user.id,
      core_competencies: selectedCoreCompetencies,
      subject_competencies: subjectCompetency
    }])
    .select()
    .single();

  if (error) {
    document.getElementById("status").innerText = error.message;
    return;
  }

  assessmentId = newAssessment.id;
}

// ðŸ”¥ Save selected strands + learning experiences

// Delete old ones if editing
await supabase
  .from("assessment_strands")
  .delete()
  .eq("assessment_id", assessmentId);

const strandRows = [];

for (let sId of selectedStrands) {
  if (selectedSLEs.length > 0) {
    selectedSLEs.forEach(sleId => {
      strandRows.push({
        assessment_id: assessmentId,
        strand_id: sId,
        learning_experience_id: sleId
      });
    });
  } else {
    strandRows.push({
      assessment_id: assessmentId,
      strand_id: sId,
      learning_experience_id: null
    });
  }
}

if (strandRows.length > 0) {
  await supabase.from("assessment_strands").insert(strandRows);
}

  
  // âœ… Save / Update results (levels only)
  const rows = Array.from(studentRows).map(tr => ({
    assessment_id: assessmentId,
    student_id: tr.dataset.id,
    subject_id: subjectId,
    term_id: termId,
    assessment_type_id: assessmentTypeId,
    achievement_level_id: tr.querySelector(".performanceLevel").value,
    academic_year: academicYear,
    teacher_id: user.id,
    created_by: user.id
  }));

  const { error: resultError } = await supabase
    .from("assessment_results")
    .upsert(rows, {
      onConflict: ['assessment_id','student_id'],
      ignoreDuplicates: false
    });

  if (resultError) {
    document.getElementById("status").innerText = resultError.message;
    return;
  }

  

  document.getElementById("status").innerText =
    "Assessment saved successfully!";
};

async function loadExistingAssessment() {
  const termSelect = document.getElementById("termSelect");
  const assessmentTypeSelect = document.getElementById("assessmentTypeSelect");
  const statusEl = document.getElementById("assessmentStatus");

  const termId = termSelect.value;
  const assessmentTypeId = assessmentTypeSelect.value;

  if (!termId || !assessmentTypeId) {
    statusEl.innerText = "";
    return null;
  }

  // 1ï¸âƒ£ Get existing assessment
  const { data: existingAssessment } = await supabase
    .from("assessments")
    .select("*")
    .eq("class_id", classId)
    .eq("subject_id", subjectId)
    .eq("term_id", termId)
    .eq("assessment_type_id", assessmentTypeId)
    .eq("academic_year", academicYear)
    .order("created_at", { ascending: false })
    .limit(1)
    .maybeSingle();

  if (!existingAssessment) {
    statusEl.innerText = "No previous assessment found. You can create a new one.";
    document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = false);
    document.getElementById("subjectCompetency").value = "";
    strandSelect.value = "";
    sleSelect.innerHTML = `<option value="" disabled selected>-- Select Learning Experience --</option>`;
    document.querySelectorAll(".coreCompetency").forEach(cb => cb.checked = false);
    return null;
  }

  // 2ï¸âƒ£ Calculate difference in days
  const createdDate = new Date(existingAssessment.created_at);
  const now = new Date();
  const diffDays = Math.floor(
  (now - createdDate) / (1000 * 60 * 60 * 24)
);

  // 3ï¸âƒ£ Load core competencies
  const selectedCoreIds = existingAssessment.core_competencies || [];
  document.querySelectorAll(".coreCompetency").forEach(cb => {
    cb.checked = selectedCoreIds.includes(cb.value);
  });

  // 4ï¸âƒ£ Load subject competencies
  document.getElementById("subjectCompetency").value = existingAssessment.subject_competencies || "";

  // 5ï¸âƒ£ Load strands + learning experiences (checkbox version)

const { data: strandData } = await supabase
  .from("assessment_strands")
  .select("*")
  .eq("assessment_id", existingAssessment.id);

if (strandData && strandData.length > 0) {

  const savedStrandIds = [...new Set(strandData.map(s => s.strand_id))];
  const savedSLEIds = strandData
    .map(s => s.learning_experience_id)
    .filter(id => id !== null);

  document.querySelectorAll(".strandCheckbox").forEach(cb => {
    cb.checked = savedStrandIds.includes(cb.value);
  });

  strandContainer.dispatchEvent(new Event("change"));

  setTimeout(() => {
    document.querySelectorAll(".sleCheckbox").forEach(cb => {
      cb.checked = savedSLEIds.includes(cb.value);
    });
  }, 300);
}

  // 6ï¸âƒ£ Load student results
  const { data: results } = await supabase
    .from("assessment_results")
    .select("*")
    .eq("assessment_id", existingAssessment.id);

  const studentRows = document.querySelectorAll("#studentsBody tr");
  studentRows.forEach(tr => {
    const studentResult = results.find(r => r.student_id === tr.dataset.id);
    if (studentResult) {
      const sel = tr.querySelector(".performanceLevel");
      sel.value = studentResult.achievement_level_id;
    }
  });


const EDIT_WINDOW_DAYS = 14;

if (diffDays <= EDIT_WINDOW_DAYS) {

  const remainingDays = EDIT_WINDOW_DAYS - diffDays;

  statusEl.innerText =
    `Existing assessment found. Editing allowed for ${remainingDays} more day(s).`;

  document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = false);
  document.getElementById("subjectCompetency").disabled = false;
  document.querySelectorAll(".strandCheckbox").forEach(cb => cb.disabled = false);
document.querySelectorAll(".sleCheckbox").forEach(cb => cb.disabled = false);
  document.querySelectorAll(".coreCompetency").forEach(cb => cb.disabled = false);

} else {

  statusEl.innerText =
    `Editing window closed (after ${EDIT_WINDOW_DAYS} days). You can create a new assessment now.`;

  document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = true);
  document.getElementById("subjectCompetency").disabled = true;
  document.querySelectorAll(".strandCheckbox").forEach(cb => cb.disabled = true);
document.querySelectorAll(".sleCheckbox").forEach(cb => cb.disabled = true);
  document.querySelectorAll(".coreCompetency").forEach(cb => cb.disabled = true);
}

  
  return existingAssessment;
}
  document.getElementById("termSelect").onchange = loadExistingAssessment;
document.getElementById("assessmentTypeSelect").onchange = loadExistingAssessment;



  // Toggle dropdown
document.getElementById("dropdownBtn").onclick = () => {
  const container = document.getElementById("coreCompetenciesContainer");
  container.style.display = container.style.display === "block" ? "none" : "block";
};

// Close dropdown if clicked outside
document.addEventListener("click", function(event) {
  const dropdown = document.querySelector(".dropdown");
  if (!dropdown.contains(event.target)) {
    document.getElementById("coreCompetenciesContainer").style.display = "none";
  }
});


// Toggle dropdowns
document.getElementById("dropdownStrandBtn").onclick = () => {
  strandContainer.style.display = strandContainer.style.display === "block" ? "none" : "block";
};
document.getElementById("dropdownSLEBtn").onclick = () => {
  sleContainer.style.display = sleContainer.style.display === "block" ? "none" : "block";
};

// Close dropdown if clicked outside
document.addEventListener("click", function(event) {
  if (!document.getElementById("dropdownStrandBtn").parentElement.contains(event.target)) {
    strandContainer.style.display = "none";
  }
  if (!document.getElementById("dropdownSLEBtn").parentElement.contains(event.target)) {
    sleContainer.style.display = "none";
  }
});
  
</script>
</body>
</html> 
