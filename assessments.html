<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Assessment - School Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  /* Global Styles */
  body {
    font-family: 'Inter', sans-serif;
    background: #f4f6f9;
    margin: 0;
    padding: 0;
    color: #333;
  }
  h2 {
  color: #1a73e8;
  font-weight: 600;
  margin-bottom: 20px;
  text-align: center;
}
  .container {
    max-width: 1200px;
    margin: auto;
    padding: 20px;
  }

  /* Card-style sections */
  .card {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }

  /* Labels and selects */
  label {
    font-weight: 500;
    display: block;
    margin-bottom: 6px;
  }
  select, input[type=text] {
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 14px;
  }

  /* Tables */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
  }
  th, td {
    padding: 12px 10px;
    text-align: left;
  }
  th {
    background: #1a73e8;
    color: #fff;
    font-weight: 500;
  }
  tr:nth-child(even) {
    background: #f9f9f9;
  }
  tr:hover {
    background: rgba(26,115,232,0.1);
  }

  /* Buttons */
  button {
    background: #1a73e8;
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 10px 16px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.3s;
  }
  button:hover {
    background: #155ab6;
  }

  /* Dropdowns */
  .dropdown {
    position: relative;
    width: 100%;
    margin-bottom: 10px;
  }
  .dropdown-content {
    display: none;
    position: absolute;
    background: #fff;
    width: 100%;
    max-height: 220px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 12px;
    z-index: 10;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .dropdown-content label {
    display: block;
    cursor: pointer;
    margin-bottom: 6px;
  }
  .dropdown-content input {
    margin-right: 8px;
  }
  .dropdown button {
    width: 100%;
    text-align: left;
    padding: 8px 10px;
    background: #f0f0f0;
    color: #333;
  }

  /* Competency sections */
  .competency-section {
    margin-top: 15px;
  }

  /* Status messages */
  #status, #assessmentStatus {
    font-weight: 500;
    margin-top: 12px;
  }
  #status {
  font-weight: 600;
  margin-top: 12px;
}
  #assessmentStatus {
    color: #1a73e8;
  }

  /* Responsive */
  @media (max-width: 768px) {
    table, th, td {
      font-size: 14px;
    }
    button {
      width: 100%;
    }
  }



/* Top row layout */
.top-row {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

/* Make cards share space */
.left-card {
  flex: 1;
}

.right-card {
  flex: 2;
}

/* Responsive */
@media (max-width: 900px) {
  .top-row {
    flex-direction: column;
  }
}
  
</style>
</head>
<body>
<div class="container">
  <h2>Smart Elimu Connect CBE Assessment & Reporting System</h2>

  <div class="top-row">

  <div class="card left-card">
    <p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>
    <p><strong>Class:</strong> <span id="classLabel"></span></p>
    <p><strong>Subject:</strong> <span id="subjectLabel"></span></p>
    <p id="assessmentStatus"></p>

    <label>Term:</label>
    <select id="termSelect"></select>

    <label>Assessment Type:</label>
    <select id="assessmentTypeSelect"></select>
  </div>

  <div class="card right-card">
    <div class="competency-section">
      <label><strong>Core Competencies:</strong></label>
      <div class="dropdown">
        <button id="dropdownBtn">Select Core Competencies ▼</button>
        <div id="coreCompetenciesContainer" class="dropdown-content"></div>
      </div>
    </div>

    <div class="competency-section">
      <label>Subject-specific Competencies (manual input):</label>
      <input type="text" id="subjectCompetency" placeholder="Enter competencies, comma-separated">
    </div>

    <div class="competency-section">
      <label><strong>Strands:</strong></label>
      <div class="dropdown">
        <button id="dropdownStrandBtn">Select Strands ▼</button>
        <div id="strandContainer" class="dropdown-content"></div>
      </div>
    </div>

    <div class="competency-section">
      <label><strong>Learning Experiences:</strong></label>
      <div class="dropdown">
        <button id="dropdownSLEBtn">Select Learning Experiences ▼</button>
        <div id="sleContainer" class="dropdown-content"></div>
      </div>
    </div>
  </div>

</div>
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Adm/Assess No.</th>
          <th>Name</th>
          <th>Performance Level</th>
        </tr>
      </thead>
      <tbody id="studentsBody">
        <tr><td colspan="3">Loading students...</td></tr>
      </tbody>
    </table>
    <br>
    <button id="saveAssessment">Save Assessment</button>
    <p id="status"></p>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const SYSTEM_YEAR = 2026;
document.getElementById("yearLabel").innerText = SYSTEM_YEAR;

const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year") || SYSTEM_YEAR;

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href = "teacher-dashboard.html";
}

// =============================
// RESET SAVE BUTTON (UTILITY)
// =============================
function resetSaveButton() {
  const saveBtn = document.getElementById("saveAssessment");
  const statusEl = document.getElementById("status");

  if (saveBtn) {
    saveBtn.disabled = false;
    saveBtn.innerText = "Save Assessment";
  }
  if (statusEl) {
    statusEl.style.color = "";
    statusEl.innerText = "";
  }
}

// =============================
// LOAD CLASS & SUBJECT
// =============================
const { data: classData } = await supabase
  .from("classes")
  .select("name")
  .eq("id", classId)
  .single();

const { data: subjectData } = await supabase
  .from("subjects")
  .select("name")
  .eq("id", subjectId)
  .single();

document.getElementById("classLabel").innerText = classData?.name || "N/A";
document.getElementById("subjectLabel").innerText = subjectData?.name || "N/A";

// =============================
// TERMS & ASSESSMENT TYPES
// =============================
const { data: terms } = await supabase.from("terms").select("id, name");
document.getElementById("termSelect").innerHTML =
  `<option value="" disabled selected>-- Select Term --</option>` +
  (terms || []).map(t => `<option value="${t.id}">${t.name}</option>`).join("");

const { data: assessmentTypes } = await supabase
  .from("assessment_types")
  .select("id, name");

document.getElementById("assessmentTypeSelect").innerHTML =
  `<option value="" disabled selected>-- Select Assessment Type --</option>` +
  (assessmentTypes || []).map(a => `<option value="${a.id}">${a.name}</option>`).join("");

// Auto-check existing assessment when term/type changes
document.getElementById("termSelect").onchange = loadExistingAssessment;
document.getElementById("assessmentTypeSelect").onchange = loadExistingAssessment;

// =============================
// CORE COMPETENCIES (RELATIONAL)
// =============================
const { data: competencies } = await supabase
  .from("competencies")
  .select("id, name, subject_id")
  .or("is_active.is.null,is_active.eq.true")
  .order("name");

const coreContainer = document.getElementById("coreCompetenciesContainer");
(coreContainer.innerHTML = "");

(competencies || [])
  .filter(c => !c.subject_id)
  .forEach(c => {
    const label = document.createElement("label");
    label.className = "competency-checkbox";

    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = c.id;
    checkbox.className = "coreCompetency";

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(c.name));
    coreContainer.appendChild(label);
  });

// =============================
// STUDENTS
// =============================
const { data: levels } = await supabase
  .from("achievement_levels")
  .select("id, label")
  .order("order_index", { ascending: true });

const { data: students } = await supabase
  .from("students")
  .select("id, admission_number, first_name, last_name")
  .eq("class_id", classId)
  .order("last_name");

const tbody = document.getElementById("studentsBody");
if (!students || !students.length) {
  tbody.innerHTML = `<tr><td colspan="3">No students in this class</td></tr>`;
} else {
  tbody.innerHTML = students.map(s => `
    <tr data-id="${s.id}">
      <td>${s.admission_number || ""}</td>
      <td>${s.first_name} ${s.last_name}</td>
      <td>
        <select class="performanceLevel">
          <option value="" disabled selected>Select Level</option>
          ${levels.map(l => `<option value="${l.id}">${l.label}</option>`).join("")}
        </select>
      </td>
    </tr>
  `).join("");
}

// =============================
// STRANDS (RELATIONAL)
// =============================
const strandContainer = document.getElementById("strandContainer");
const sleContainer = document.getElementById("sleContainer");

const { data: strands } = await supabase
  .from("strands")
  .select("id, name")
  .eq("subject_id", subjectId)
  .eq("grade", 10)
  .order("name");

(strands || []).forEach(s => {
  const label = document.createElement("label");
  label.className = "competency-checkbox";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.value = s.id;
  checkbox.className = "strandCheckbox";

  label.appendChild(checkbox);
  label.appendChild(document.createTextNode(s.name));
  strandContainer.appendChild(label);
});

// Load SLEs when strands change
async function loadSLEsForSelectedStrands() {
  const selected = Array.from(
    document.querySelectorAll(".strandCheckbox:checked")
  ).map(cb => cb.value);

  sleContainer.innerHTML = "";
  if (!selected.length) return;

  for (let strandId of selected) {
    const { data: sles } = await supabase
      .from("learning_experiences")
      .select("id, name")
      .eq("strand_id", strandId)
      .order("name");

    (sles || []).forEach(sle => {
      const label = document.createElement("label");
      label.className = "competency-checkbox";

      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = sle.id;
      checkbox.className = "sleCheckbox";
      checkbox.dataset.strandId = strandId;

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(
        `${sle.name} (${strands.find(st => st.id === strandId)?.name || ""})`
      ));
      sleContainer.appendChild(label);
    });
  }
}

// attach change listeners
document.querySelectorAll(".strandCheckbox").forEach(cb => {
  cb.addEventListener("change", loadSLEsForSelectedStrands);
});

// =============================
// SAVE ASSESSMENT (RELATIONAL)
// =============================
document.getElementById("saveAssessment").onclick = async () => {
  const statusEl = document.getElementById("status");
  const saveBtn = document.getElementById("saveAssessment");

  statusEl.style.color = "#1a73e8";
  statusEl.innerText = "Saving assessment...";
  saveBtn.disabled = true;
  saveBtn.innerText = "Saving...";

  try {
    const selectedStrands = Array.from(
      document.querySelectorAll(".strandCheckbox:checked")
    ).map(cb => cb.value);

    if (!selectedStrands.length) {
      alert("Please select at least one strand.");
      resetSaveButton();
      return;
    }

    const termId = document.getElementById("termSelect").value;
    const assessmentTypeId = document.getElementById("assessmentTypeSelect").value;
    const selectedCore = Array.from(
      document.querySelectorAll(".coreCompetency:checked")
    ).map(cb => cb.value);

    if (!termId || !assessmentTypeId) {
      alert("Select Term and Assessment Type.");
      resetSaveButton();
      return;
    }

    if (!selectedCore.length) {
      alert("Select at least one core competency.");
      resetSaveButton();
      return;
    }

    // validate students
    const studentRows = document.querySelectorAll("#studentsBody tr");
    let missing = false;
    studentRows.forEach(row => {
      const level = row.querySelector(".performanceLevel")?.value;
      if (!level) {
        missing = true;
        row.style.backgroundColor = "rgba(255,0,0,0.2)";
      } else {
        row.style.backgroundColor = "";
      }
    });

    if (missing) {
      alert("Some students are missing performance levels.");
      resetSaveButton();
      return;
    }

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return (window.location.href = "index.html");

    const { data: profile } = await supabase
      .from("profiles")
      .select("school_id")
      .eq("auth_id", user.id)
      .single();

    if (!profile?.school_id) {
      alert("Cannot determine school.");
      resetSaveButton();
      return;
    }

    const schoolId = profile.school_id;
    const today = new Date().toISOString();
    const assessmentTitle =
      `${subjectData.name} - ${document.getElementById("termSelect").selectedOptions[0].text} (${academicYear})`;

    // find existing
    let { data: existing } = await supabase
      .from("assessments")
      .select("*")
      .eq("class_id", classId)
      .eq("subject_id", subjectId)
      .eq("term_id", termId)
      .eq("assessment_type_id", assessmentTypeId)
      .eq("academic_year", academicYear)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    let assessmentId;

    if (existing) {
      const diffDays = Math.floor(
        (new Date() - new Date(existing.created_at)) /
        (1000 * 60 * 60 * 24)
      );

      if (diffDays <= 14) {
        assessmentId = existing.id;
        await supabase.from("assessments")
          .update({
            core_competencies: selectedCore,
            subject_competencies:
              document.getElementById("subjectCompetency").value.trim()
          })
          .eq("id", assessmentId);
      } else {
        const { data: newAssessment, error } = await supabase
          .from("assessments")
          .insert([{
            title: assessmentTitle,
            class_id: classId,
            subject_id: subjectId,
            learning_area_id: subjectId,
            school_id: schoolId,
            term_id: termId,
            academic_year: academicYear,
            assessment_type_id: assessmentTypeId,
            assessment_date: today,
            created_by: user.id,
            core_competencies: selectedCore,
            subject_competencies:
              document.getElementById("subjectCompetency").value.trim()
          }])
          .select()
          .single();

        if (error) throw new Error(error.message);
        assessmentId = newAssessment.id;
      }
    } else {
      const { data: newAssessment, error } = await supabase
        .from("assessments")
        .insert([{
          title: assessmentTitle,
          class_id: classId,
          subject_id: subjectId,
          learning_area_id: subjectId,
          school_id: schoolId,
          term_id: termId,
          academic_year: academicYear,
          assessment_type_id: assessmentTypeId,
          assessment_date: today,
          created_by: user.id,
          core_competencies: selectedCore,
          subject_competencies:
            document.getElementById("subjectCompetency").value.trim()
        }])
        .select()
        .single();

      if (error) throw new Error(error.message);
      assessmentId = newAssessment.id;
    }

    // RELATIONAL STRANDS & SLEs (one row per SLE)
    await supabase.from("assessment_strands")
      .delete()
      .eq("assessment_id", assessmentId);

    const strandRows = [];
    const sleMap = {};

    document.querySelectorAll(".sleCheckbox:checked").forEach(cb => {
      const sid = cb.dataset.strandId;
      if (!sleMap[sid]) sleMap[sid] = [];
      sleMap[sid].push(cb.value);
    });

    selectedStrands.forEach(sid => {
      const sles = sleMap[sid] || [];
      if (sles.length) {
        sles.forEach(sleId => {
          strandRows.push({
            assessment_id: assessmentId,
            strand_id: sid,
            learning_experience_id: sleId
          });
        });
      } else {
        strandRows.push({
          assessment_id: assessmentId,
          strand_id: sid,
          learning_experience_id: null
        });
      }
    });

    if (strandRows.length) {
      const { error } = await supabase
        .from("assessment_strands")
        .insert(strandRows);

      if (error) throw new Error(error.message);
    }

    // save results
    const rows = Array.from(studentRows).map(tr => ({
      assessment_id: assessmentId,
      student_id: tr.dataset.id,
      subject_id: subjectId,
      term_id: termId,
      assessment_type_id: assessmentTypeId,
      achievement_level_id: tr.querySelector(".performanceLevel").value,
      academic_year: academicYear,
      teacher_id: user.id,
      created_by: user.id
    }));

    const { error: resultError } = await supabase
      .from("assessment_results")
      .upsert(rows, { onConflict: ["assessment_id","student_id"] });

    if (resultError) throw new Error(resultError.message);

    statusEl.style.color = "green";
    statusEl.innerText = "Assessment saved successfully!";
  } catch (err) {
    statusEl.style.color = "red";
    statusEl.innerText = "Error: " + err.message;
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerText = "Save Assessment";
  }
};

// =============================
// LOAD EXISTING ASSESSMENT
// =============================
async function loadExistingAssessment() {
  const termSelect = document.getElementById("termSelect");
  const assessmentTypeSelect = document.getElementById("assessmentTypeSelect");
  const statusEl = document.getElementById("assessmentStatus");

  const termId = termSelect.value;
  const assessmentTypeId = assessmentTypeSelect.value;

  if (!termId || !assessmentTypeId) {
    statusEl.innerText = "";
    return null;
  }

  const { data: existing } = await supabase
    .from("assessments")
    .select("*")
    .eq("class_id", classId)
    .eq("subject_id", subjectId)
    .eq("term_id", termId)
    .eq("assessment_type_id", assessmentTypeId)
    .eq("academic_year", academicYear)
    .order("created_at", { ascending: false })
    .limit(1)
    .maybeSingle();

  if (!existing) {
    statusEl.innerText = "No previous assessment found.";
    document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = false);
    document.getElementById("subjectCompetency").value = "";
    document.querySelectorAll(".strandCheckbox").forEach(cb => cb.checked = false);
    document.querySelectorAll(".coreCompetency").forEach(cb => cb.checked = false);
    sleContainer.innerHTML = "";
    return null;
  }

  const diffDays = Math.floor(
    (new Date() - new Date(existing.created_at)) /
    (1000 * 60 * 60 * 24)
  );

  document.querySelectorAll(".coreCompetency").forEach(cb => {
    cb.checked = (existing.core_competencies || []).includes(cb.value);
  });

  document.getElementById("subjectCompetency").value =
    existing.subject_competencies || "";

  const { data: strandData } = await supabase
    .from("assessment_strands")
    .select("*")
    .eq("assessment_id", existing.id);

  const savedSLEIds = (strandData || []).map(r => r.learning_experience_id).filter(Boolean);

  document.querySelectorAll(".strandCheckbox").forEach(cb => {
    cb.checked = (strandData || []).some(r => r.strand_id === cb.value);
  });

  await loadSLEsForSelectedStrands();

  setTimeout(() => {
    document.querySelectorAll(".sleCheckbox").forEach(cb => {
      cb.checked = savedSLEIds.includes(cb.value);
    });
  }, 100);

  const { data: results } = await supabase
    .from("assessment_results")
    .select("*")
    .eq("assessment_id", existing.id);

  document.querySelectorAll("#studentsBody tr").forEach(tr => {
    const r = (results || []).find(x => x.student_id === tr.dataset.id);
    if (r) tr.querySelector(".performanceLevel").value = r.achievement_level_id;
  });

  const EDIT_WINDOW_DAYS = 14;
  if (diffDays <= EDIT_WINDOW_DAYS) {
    statusEl.innerText =
      `Editing allowed for ${EDIT_WINDOW_DAYS - diffDays} more day(s).`;
    document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = false);
    document.getElementById("subjectCompetency").disabled = false;
    document.querySelectorAll(".strandCheckbox").forEach(cb => cb.disabled = false);
    document.querySelectorAll(".sleCheckbox").forEach(cb => cb.disabled = false);
    document.querySelectorAll(".coreCompetency").forEach(cb => cb.disabled = false);
  } else {
    statusEl.innerText =
      `Editing window closed (after ${EDIT_WINDOW_DAYS} days). Create new assessment.`;
    document.querySelectorAll(".performanceLevel").forEach(sel => sel.disabled = true);
    document.getElementById("subjectCompetency").disabled = true;
    document.querySelectorAll(".strandCheckbox").forEach(cb => cb.disabled = true);
    document.querySelectorAll(".sleCheckbox").forEach(cb => cb.disabled = true);
    document.querySelectorAll(".coreCompetency").forEach(cb => cb.disabled = true);
  }

  return existing;
}

document.addEventListener("click", e => {
  if (!document.getElementById("dropdownBtn").parentElement.contains(e.target)) {
    coreContainer.style.display = "none";
  }
  if (!document.getElementById("dropdownStrandBtn").parentElement.contains(e.target)) {
    strandContainer.style.display = "none";
  }
  if (!document.getElementById("dropdownSLEBtn").parentElement.contains(e.target)) {
    sleContainer.style.display = "none";
  }
});

</script>
</body>
</html> 
