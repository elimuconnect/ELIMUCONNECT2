 <!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Assessment Students</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f0f0f0; }
  select, input { width: 100%; padding: 4px; }
  button { margin-top: 15px; padding: 8px 12px; cursor: pointer; }
  .competency-section { margin-top: 20px; }
  .competency-checkbox { display: block; margin-bottom: 6px; cursor: pointer; }
  .competency-checkbox input { margin-right: 6px; }
</style>
</head>
<body>
<h2>New Assessment Table</h2>

<p><strong>Academic Year:</strong> <span id="yearLabel"></span></p>
<p><strong>Class:</strong> <span id="classLabel"></span></p>
<p><strong>Subject:</strong> <span id="subjectLabel"></span></p>

<p>
  <label>Term:</label>
  <select id="termSelect"></select>
</p>

<p>
  <label>Assessment Type:</label>
  <select id="assessmentTypeSelect"></select>
</p>

<!-- Core Competencies -->
<div class="competency-section">
  <label><strong>Core Competencies:</strong></label>
  <div id="coreCompetenciesContainer"></div>
</div>

<!-- Subject-specific manual input -->
<div class="competency-section">
  <label>Subject-specific Competencies (manual input):</label>
  <input type="text" id="subjectCompetency" 
         placeholder="Enter subject-specific competencies, comma-separated">
</div>

<!-- Strand/Substrand -->
<p>
  <label>Strand:</label>
  <select id="strandSelect">
    <option value="" disabled selected>-- Select Strand --</option>
  </select>
</p>

<p>
  <label>Substrand (optional):</label>
  <select id="substrandSelect">
    <option value="" disabled selected>-- Select Substrand --</option>
  </select>
</p>

<table>
  <thead>
    <tr>
      <th>Adm/Assess NO.</th>
      <th>Name</th>
      <th>Performance Level</th>
    </tr>
  </thead>
  <tbody id="studentsBody">
    <tr><td colspan="3">Loading students...</td></tr>
  </tbody>
</table>

<br>
<button id="saveAssessment">Save Assessment</button>
<p id="status"></p>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://zcmzuetusvpmvubbjlmx.supabase.co",
  "sb_publishable_-BGJLAySaH7bQ5lBIZF9zg_eohK-xEn"
);

const SYSTEM_YEAR = 2026;
document.getElementById("yearLabel").innerText = SYSTEM_YEAR;

const classId = localStorage.getItem("class_id");
const subjectId = localStorage.getItem("subject_id");
const academicYear = localStorage.getItem("academic_year") || SYSTEM_YEAR;

if (!classId || !subjectId) {
  alert("Please select a class and subject first.");
  window.location.href="teacher-dashboard.html";
}

// Display class and subject
const { data: classData } = await supabase.from("classes").select("name").eq("id", classId).single();
const { data: subjectData } = await supabase.from("subjects").select("name").eq("id", subjectId).single();
document.getElementById("classLabel").innerText = classData?.name || "N/A";
document.getElementById("subjectLabel").innerText = subjectData?.name || "N/A";

// Load terms
const { data: terms } = await supabase.from("terms").select("id, name");
document.getElementById("termSelect").innerHTML = `<option value="" disabled selected>-- Select Term --</option>${terms.map(t => `<option value="${t.id}">${t.name}</option>`).join("")}`;

// Load assessment types
const { data: assessmentTypes } = await supabase.from("assessment_types").select("id, name");
document.getElementById("assessmentTypeSelect").innerHTML = `<option value="" disabled selected>-- Select Assessment Type --</option>${assessmentTypes.map(a => `<option value="${a.id}">${a.name}</option>`).join("")}`;

// Load achievement levels
const { data: levels } = await supabase
  .from("achievement_levels")
  .select("id, label")
  .order("order_index", { ascending: true });
// Load competencies and populate top core competencies
const { data: competencies } = await supabase.from("competencies").select("id, name, subject_id").or("is_active.is.null,is_active.eq.true").order("name");
const coreContainer = document.getElementById("coreCompetenciesContainer");

competencies
  .filter(c => !c.subject_id)   // Only global core competencies
  .forEach(c => {
    const label = document.createElement("label");
    label.className = "competency-checkbox";
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.value = c.id;
    checkbox.className = "coreCompetency";
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(c.name));
    coreContainer.appendChild(label);
  });

// Load students
const { data: students } = await supabase.from("students").select("id, admission_number, first_name, last_name").eq("class_id", classId).order("last_name");
const tbody = document.getElementById("studentsBody");
if (!students?.length) tbody.innerHTML = `<tr><td colspan="3">No students in this class</td></tr>`;
else tbody.innerHTML = students.map(s => `
<tr data-id="${s.id}">
  <td>${s.admission_number || ""}</td>
  <td>${s.first_name} ${s.last_name}</td>
  <td>
    <select class="performanceLevel">
      <option value="" disabled selected>Select Level</option>
      ${levels.map(l => `<option value="${l.id}">${l.label}</option>`).join("")}
    </select>
  </td>
</tr>`).join("");

// Load strands and sub-strands from DB
const strandSelect = document.getElementById("strandSelect");
const substrandSelect = document.getElementById("substrandSelect");

// Load strands for the selected subject
const { data: strands } = await supabase.from("strands")
  .select("id, name")
  .eq("subject_id", subjectId)
  .eq("grade", 10)
  .order("name");

strands.forEach(s => strandSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`);

// Load sub-strands when a strand is selected
strandSelect.onchange = async () => {
  const strandId = strandSelect.value;
  const { data: subStrands } = await supabase.from("sub_strands")
    .select("id, name")
    .eq("strand_id", strandId)
    .order("name");
  substrandSelect.innerHTML = `<option value="" disabled selected>-- Select Substrand --</option>`;
  subStrands.forEach(ss => substrandSelect.innerHTML += `<option value="${ss.id}">${ss.name}</option>`);
};

// Save assessment
document.getElementById("saveAssessment").onclick = async () => {
  // Get selected values
  const strand = strandSelect.value;
  const substrand = substrandSelect.value || null;
  const termId = document.getElementById("termSelect").value;
  const termName = document.getElementById("termSelect").selectedOptions[0]?.text;
  const assessmentTypeId = document.getElementById("assessmentTypeSelect").value;

  const selectedCoreCompetencies = Array.from(document.querySelectorAll(".coreCompetency:checked"))
                                        .map(cb => cb.value);
  const subjectCompetency = document.getElementById("subjectCompetency").value;

  // --------------------
  // 2️⃣ & 3️⃣ CBC-compliant validation BEFORE inserting results
  // --------------------

  // Step 2: Validate required selections
  if (!termId || !assessmentTypeId || !strand) {
    alert("Please select Term, Assessment Type, and Strand before saving.");
    return;
  }
  if (!selectedCoreCompetencies.length) {
    alert("Please select at least one core competency before saving.");
    return;
  }

  const studentRows = document.querySelectorAll("#studentsBody tr");
let missingLevel = false;

for (let row of studentRows) {
  const levelSelect = row.querySelector(".performanceLevel");
  if (!levelSelect) continue; // Skip placeholder rows
  const level = levelSelect.value;

  // Reset previous highlighting
  row.style.backgroundColor = "";

  if (!level) {
    missingLevel = true;
    row.style.backgroundColor = "rgba(255,0,0,0.2)"; // Highlight the row in light red
  }

  // Optional: remove highlight when a level is selected
  levelSelect.onchange = () => row.style.backgroundColor = "";
}

if (missingLevel) {
  alert("Some students are missing a Performance Level. Highlighted in red. Please complete before saving.");
  return; // Stop saving until teacher corrects
}
  

  // --------------------
  // Get logged-in user
  // --------------------
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { window.location.href="index.html"; return; }

  const { data: profile } = await supabase.from("profiles")
                                         .select("school_id")
                                         .eq("auth_id", user.id)
                                         .single();
  if (!profile?.school_id) { alert("Cannot determine school_id"); return; }
  const schoolId = profile.school_id;

  const today = new Date().toISOString();
  const assessmentTitle = `${subjectData.name} - ${termName} (${academicYear})`;

  // --------------------
  // Insert assessment
  // --------------------
  const { data: assessment, error: assessmentError } = await supabase.from("assessments").insert([{
    title: assessmentTitle,
    class_id: classId,
    subject_id: subjectId,
    school_id: schoolId,
    term_id: termId,
    term: termName,
    academic_year: academicYear,
    assessment_type_id: assessmentTypeId,
    learning_area_id: subjectId,
    assessment_date: today,
    created_by: user.id,
    core_competencies: selectedCoreCompetencies,
    subject_competencies: subjectCompetency
  }]).select().single();

  if (assessmentError) {
    document.getElementById("status").innerText = `Error saving assessment: ${assessmentError.message}`;
    return;
  }

  // --------------------
  // Insert per-student results
  // --------------------
  const rows = Array.from(studentRows).map(tr => ({
    assessment_id: assessment.id,
    student_id: tr.dataset.id,
    subject_id: subjectId,
    term_id: termId,
    assessment_type_id: assessmentTypeId,
    achievement_level_id: tr.querySelector(".performanceLevel").value,
    academic_year: academicYear,
    teacher_id: user.id,
    created_by: user.id
  }));

  const { error: resultError } = await supabase.from("assessment_results").insert(rows);
  if (resultError) {
    document.getElementById("status").innerText = `Error saving results: ${resultError.message}`;
    return;
  }

  // --------------------
  // Insert strand & substrand
  // --------------------
  if (strand) {
    const { error: strandError } = await supabase.from("assessment_strands").insert([{
      assessment_id: assessment.id,
      strand_id: strand,
      substrand_id: substrand
    }]);
    if (strandError) {
      document.getElementById("status").innerText = `Error saving strand: ${strandError.message}`;
      return;
    }
  }

  // ✅ Success
  document.getElementById("status").innerText = "Assessment and results saved successfully!";
  console.log("Selected term ID:", termId);
};



</script>
</body>
</html>
